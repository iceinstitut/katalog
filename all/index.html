<html>
  <head>
  <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"> -->
    <title>Katalog All Courses ICE Institute</title>
    <script src="../load-components.js"></script>
    <script src="../load-head.js"></script>
    <style>
      .placeholder-card {
        height: 220px;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        background-color: #f8f9fa;
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0% {
          background-color: #f8f9fa;
        }

        50% {
          background-color: #e9ecef;
        }

        100% {
          background-color: #f8f9fa;
        }
      }

      .hero {
        background-color: #F6F6F6;
        white-space: pre-line;
      }

      .hero__content {
        align-items: center;
        display: flex;
        font-family: Inter;
        justify-content: space-between;
        max-height: 350px;
        min-height: 310px;
      }

      .container-mw-xl {
        max-width: 1472px !important;
      }

      .hero__content .highlighted {
        color: #EE1522;
      }

      .hero__content .hero__image,
      .hero__content div {
        height: 100%;
        max-height: 350px;
        min-height: 310px;
      }
    </style>
  </head>
  <body>
    <div id="header"></div>
    <section class="hero px-1">
      <div class="hero__content container-mw-xl container-fluid">
        <h1 class="display-1">
          <span class="highlighted">Explore world-class learning</span>
          <p class="h3 font-weight-normal"> Unmatched quality. Market relevance. Comprehensive solutions.</p>
        </h1>
        <div>
          <img srcset="https://explore-catalog.edx.org/268786007dcaf1c752de4d68513fd103.png 1000w, https://explore-catalog.edx.org/268786007dcaf1c752de4d68513fd103.png 2000w" src="https://explore-catalog.edx.org/268786007dcaf1c752de4d68513fd103.png" alt="People learning and performing highly skilled tasks" sizes="33vw" class="hero__image">
        </div>
      </div>
    </section>

    <main class="container py-3">
      
      <h1 class="fw-bold text-body-emphasis">Search our catalog</h1>
      <div class="input-group mb-3">
      <span class="input-group-text" id="basic-addon1"><i class="bi bi-search" style="font-size: 2rem;"></i></span>
      <input type="text" id="searchInput" class="form-control form-control-lg" style="font-size: 2rem;">
    </div>

      <!-- FILTERS ROW -->
      <div class="row g-2 align-items-center mb-3" id="filtersRow" style="display:none;">
        <div class="col-6 col-md-2">
          <select id="filterInstitution" class="form-select">
            <option value="">All Institution</option>
          </select>
        </div>
        <div class="col-6 col-md-2">
          <select id="filterCategory" class="form-select">
            <option value="">All Category</option>
          </select>
        </div>
        <div class="col-6 col-md-2">
          <select id="filterPacing" class="form-select">
            <option value="">All Pacing</option>
          </select>
        </div>
        <div class="col-6 col-md-2">
          <select id="filterLevel" class="form-select">
            <option value="">All Level</option>
          </select>
        </div>
        <div class="col-6 col-md-2">
          <select id="filterKemampuan" class="form-select">
            <option value="">All Skill</option>
          </select>
        </div>
        <div class="col-6 col-md-2">
          <select id="filterBahasa" class="form-select">
            <option value="">Language</option>
          </select>
        </div>
        <div class="col-6 col-md-2">
          <select id="filterTipe" class="form-select">
            <option value="">Learning Type</option>
          </select>
        </div>
        <div class="col-6 col-md-2">
          <select id="filterPlatform" class="form-select">
            <option value="">Partner</option>
          </select>
        </div>
        <div class="col-6 col-md-2">
		  <select id="filterHarga" class="form-select">
		    <option value="">All Price</option>
		    <option value="free">Free</option>
		    <option value="paid">Paid</option>
		  </select>
		</div>
        <div class="col-12 col-md-2 d-grid">
          <button id="btnResetFilters" class="btn btn-outline-secondary">Reset</button>
        </div>
      </div>

      <div class="mb-2 text-end text-muted" id="dataInfo"></div>

      <div id="cardContainer" class="row g-4"></div>

      <nav class="mt-4">
        <ul class="pagination justify-content-center" id="pagination"></ul>
      </nav>
    </main>

    <div id="footer"></div>

    <script>
  // == KONFIG ==
  const SHEET_ID = '1pdjgaXanB9SmUlUCb1sRfPM48MPerHxfjL6Hpty6J3w'; 
const API_KEY = 'AIzaSyAbXfG0N-mrwxu-GTdrk36ycLQfffxkd3U'; 
const RANGE = 'All'; 
const apiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;

  const itemsPerPage = 12;

  // == STATE ==
  let items = [];
  let total = 0;
  let currentPage = 1;
  let currentController = null;      // AbortController untuk batalkan request lama
  const cache = new Map();           // cache response per querystring
  let allData = []; // Menyimpan seluruh data dari Google Sheets


  // == ELEMENTS (sesuaikan dengan id di HTML Anda) ==
  const el = {
    search: document.getElementById("searchInput"),
    info: document.getElementById("dataInfo"),
    cards: document.getElementById("cardContainer"),
    pagination: document.getElementById("pagination"),
    filtersRow: document.getElementById("filtersRow"),
    fInstitution: document.getElementById("filterInstitution"),
    fCategory: document.getElementById("filterCategory"),
    fPacing: document.getElementById("filterPacing"),
    fLevel: document.getElementById("filterLevel"),
    fKemampuan: document.getElementById("filterKemampuan"),
    fBahasa: document.getElementById("filterBahasa"),
    fTipe: document.getElementById("filterTipe"),    
    fPlatform: document.getElementById("filterPlatform"),
    fHarga: document.getElementById("filterHarga"),
    btnReset: document.getElementById("btnResetFilters"),
  };

  // == LOADING UI (overlay hanya area kartu + top progress bar global) ==
  // ===== LOADING UI =====
let loadingOverlay, loadingBar, loadingTimer;

function ensureLoadingUI() {
  // Top progress bar (global)
  if (!loadingBar) {
    loadingBar = document.createElement('div');
    loadingBar.style.cssText = `
      position:fixed; left:0; top:0; height:3px; width:0%;
      background:linear-gradient(90deg, #0d6efd, #66b2ff);
      transition:width .3s ease, opacity .5s ease;
      opacity:0;
      z-index:10000;`;
    document.body.appendChild(loadingBar);
  }

  // Overlay di dalam #cardContainer
  if (!loadingOverlay) {
    const host = el.cards; // #cardContainer
    const cs = window.getComputedStyle(host);
    if (cs.position === 'static') host.style.position = 'relative';

    loadingOverlay = document.createElement('div');
    loadingOverlay.style.cssText = `
      position:absolute; inset:0;
      display:none; align-items:center; justify-content:center;
      background:rgba(255,255,255,.75);
      backdrop-filter:saturate(150%) blur(3px);
      z-index:10; pointer-events:auto;`;
    loadingOverlay.innerHTML = `
      <div style="display:flex; gap:.75rem; align-items:center; font-weight:600;">
        <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
        <span>Memuat‚Ä¶</span>
      </div>`;
    host.appendChild(loadingOverlay);
  }
}

// Aktif / nonaktifkan loading
function setLoading(active) {
  ensureLoadingUI();
  clearInterval(loadingTimer);

  if (active) {
    // Mulai progress bar
    loadingOverlay.style.display = 'flex';
    loadingBar.style.opacity = '1';
    loadingBar.style.width = '10%';

    let width = 10;
    loadingTimer = setInterval(() => {
      if (width < 90) {
        width += Math.random() * 10; // naik bertahap
        loadingBar.style.width = width + '%';
      }
    }, 400);
  } else {
    // Selesaikan dan sembunyikan dengan halus
    loadingBar.style.width = '100%';
    setTimeout(() => {
      loadingBar.style.opacity = '0';
      loadingBar.style.width = '0%';
      clearInterval(loadingTimer);
    }, 500);

    loadingOverlay.style.display = 'none';
  }
}

  // == HELPERS ==
  const lc = v => (v ?? "").toString().toLowerCase();
  function escapeHtml(str) {
    return String(str ?? '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }
  function escapeAttr(str){ return escapeHtml(str).replaceAll('\n',' '); }

  function fillSelect(selectEl, values, placeholder) {
    const current = selectEl.value;
    const opts = ['<option value="">' + placeholder + '</option>']
      .concat(values.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`));
    selectEl.innerHTML = opts.join("");
    if (values.includes(current)) selectEl.value = current;
  }

  function buildQS() {
    const params = new URLSearchParams();
    params.set("mode", "list");
    params.set("page", currentPage);
    params.set("limit", itemsPerPage);

    const q = el.search.value.trim();
    if (q.length >= 2) params.set("q", q);

    if (el.fInstitution.value) params.set("institution", el.fInstitution.value);
    if (el.fCategory.value)    params.set("category", el.fCategory.value);
    if (el.fPacing.value)      params.set("pacing_or_type", el.fPacing.value);
    if (el.fLevel.value)       params.set("level", el.fLevel.value);
    if (el.fKemampuan.value)   params.set("kemampuan", el.fKemampuan.value);
    if (el.fBahasa.value)      params.set("bahasa", el.fBahasa.value);
    if (el.fTipe.value)      params.set("tipe", el.fTipe.value);
    if (el.fPlatform.value)      params.set("platform", el.fPlatform.value);

    return params.toString();
  }

  function renderSkeleton(count = itemsPerPage) {
    el.cards.innerHTML = Array.from({ length: count }).map(() => `
      <div class="col-md-6 col-lg-3">
        <div class="placeholder-card p-3" aria-busy="true" aria-live="polite"></div>
      </div>`).join("");
  }

  function renderEmptyState() {
    el.cards.innerHTML = `
      <div class="col-12">
        <div class="text-center text-muted py-5">
          <div class="mb-2">üôÅ</div>
          <h5 class="mb-2">Tidak ada hasil</h5>
          <p class="mb-3">Coba longgarkan filter atau ubah kata kunci pencarian.</p>
          <button class="btn btn-outline-secondary" id="btnClearFilters">Bersihkan Filter</button>
        </div>
      </div>`;
    const btn = document.getElementById('btnClearFilters');
    if (btn) btn.addEventListener('click', () => {
      el.search.value = "";
      el.fInstitution.value = "";
      el.fCategory.value = "";
      el.fPacing.value = "";
      el.fLevel.value = "";
      el.fKemampuan.value = "";
      el.fBahasa.value = "";
      el.fTipe.value = "";
      el.fPlatform.value = "";
      loadPage(1);
    });
  }

  async function loadMeta() {
  try {
    const res = await fetch(apiUrl);
    const data = await res.json();
    const values = data.values || [];
    if (values.length < 2) return;

    const headers = values[0];
    const rows = values.slice(1).map(row => {
      const obj = {};
      headers.forEach((h, i) => {
        obj[h.trim().toLowerCase().replace(/\s+/g, "_")] = row[i] || "";
      });
      return obj;
    });

    // Simpan semua data ke variabel global
    allData = rows;

    // Generate nilai unik untuk setiap filter dropdown
    const getUnique = key => {
	  const multiValueKeys = ["institution", "category", "kemampuan"]; // kolom dengan banyak nilai
	  const values = rows.flatMap(r => {
	    const val = r[key] || "";
	    if (multiValueKeys.includes(key)) {
	      return val.split(";").map(v => v.trim()).filter(Boolean);
	    }
	    return [val.trim()].filter(Boolean);
	  });
	  return [...new Set(values)].sort();
	};


    applyMeta({
      institution: getUnique("institution"),
      category: getUnique("category"),
      level: getUnique("level"),
      pacing_or_type: getUnique("pacing_or_type"),
      bahasa: getUnique("bahasa"),
      tipe: getUnique("tipe"),      
      platform: getUnique("platform"),
      kemampuan: getUnique("kemampuan"),
    });
  } catch (err) {
    console.error("Gagal memuat meta:", err);
  }
}

  function applyMeta(meta) {
    fillSelect(el.fInstitution, meta.institution || [], "All Institution");
    fillSelect(el.fCategory,    meta.category || [], "All Category");
    fillSelect(el.fPacing,      meta.pacing_or_type || [], "All Pacing");
    fillSelect(el.fLevel,       meta.level || [], "All Level");
    fillSelect(el.fKemampuan,   meta.kemampuan || [], "All Skill");
    fillSelect(el.fBahasa,      meta.bahasa || [], "All Language");
    fillSelect(el.fTipe,      meta.tipe || [], "All Learning Type");
    fillSelect(el.fPlatform,      meta.platform || [], "All Partner");
    el.filtersRow.style.display = "";
  }

  async function loadPage(page = 1) {
  currentPage = page;
  renderSkeleton();
  setLoading(true);

  try {
    if (!allData.length) {
      // Jika data belum dimuat (fallback)
      const res = await fetch(apiUrl);
      const data = await res.json();
      const headers = data.values[0];
      const rows = data.values.slice(1).map(row => {
        const obj = {};
        headers.forEach((h, i) => {
          obj[h.trim().toLowerCase().replace(/\s+/g, "_")] = row[i] || "";
        });
        return obj;
      });
      allData = rows;
    }

    // Filter dan pencarian
    const q = el.search.value.trim().toLowerCase();
    const fInstitution = el.fInstitution.value.trim().toLowerCase();
    const fCategory = el.fCategory.value.trim().toLowerCase();
    const fLevel = el.fLevel.value.trim().toLowerCase();
    const fPacing = el.fPacing.value.trim().toLowerCase();
    const fKemampuan = el.fKemampuan.value.trim().toLowerCase();
    const fBahasa = el.fBahasa.value.trim().toLowerCase();
    const fTipe = el.fTipe.value.trim().toLowerCase();
    const fPlatform = el.fPlatform.value.trim().toLowerCase();
    const fHarga = el.fHarga.value.trim().toLowerCase();

    let filtered = allData.filter(item => {
      const matchSearch = !q || Object.values(item).some(v => v.toLowerCase().includes(q));
      function matchMulti(value, filter) {
		  if (!filter) return true;
		  return value
		    .toLowerCase()
		    .split(";")
		    .map(v => v.trim())
		    .includes(filter);
		}
      	const matchInstitution = matchMulti(item.institution || "", fInstitution);
		const matchCategory = matchMulti(item.category || "", fCategory);
		const matchKemampuan = matchMulti(item.kemampuan || "", fKemampuan);
      const matchLevel = !fLevel || item.level.toLowerCase() === fLevel;
      const matchPacing = !fPacing || item.pacing_or_type.toLowerCase() === fPacing;
      const matchBahasa = !fBahasa || item.bahasa.toLowerCase() === fBahasa;
      const matchTipe = !fTipe || item.tipe.toLowerCase() === fTipe;
      const matchPlatform = !fPlatform || item.platform.toLowerCase() === fPlatform;
      // üîπ Logika harga
	  const hargaValue = parseFloat(item.harga || "0");
	  const hargaType = hargaValue === 0 ? "free" : "paid";
	  const matchHarga = !fHarga || hargaType === fHarga;

      return (
        matchSearch &&
        matchInstitution &&
        matchCategory &&
        matchLevel &&
        matchPacing &&
        matchKemampuan &&
        matchBahasa &&
        matchTipe &&
        matchPlatform &&
    	matchHarga
      );
    });

    // Pagination lokal
    total = filtered.length;
    const start = (page - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    items = filtered.slice(start, end);

    if (!items.length) renderEmptyState();
    else renderCards();

    renderPagination();
    updateDataInfo();

  } catch (err) {
    console.error(err);
    el.cards.innerHTML = `<div class="col-12"><div class="alert alert-warning">Gagal memuat data.</div></div>`;
  } finally {
    setLoading(false);
  }
}

  // Prefetch halaman berikutnya untuk UX mulus saat klik "Berikutnya"
  async function prefetchNext(currentQs) {
    try {
      const url = new URL(`${apiUrl}?${currentQs}`);
      const params = url.searchParams;
      const page = parseInt(params.get('page') || '1', 10);
      const limit = parseInt(params.get('limit') || String(itemsPerPage), 10);
      const totalPages = Math.max(1, Math.ceil((total || 0) / limit));
      if (page < totalPages) {
        params.set('page', String(page + 1));
        const nextQs = params.toString();
        if (!cache.has(nextQs)) {
          const res = await fetch(`${apiUrl}?${nextQs}`);
          const data = await res.json();
          cache.set(nextQs, data);
        }
      }
    } catch(_){}
  }

  function renderCards() {
    const DEFAULT_COVER = 'https://iceinstitut.github.io/image/aset/cover-default.jpg';
    el.cards.innerHTML = items.map(item => {
      const courseName = (item.course_name ?? '').toString();
      const institution = (item.institution ?? '').toString();
      const start_date = (item.start_date ?? '').toString();
      const end_date = (item.end_date ?? '').toString();
      const harga = (item.harga ?? '').toString();

      // Logo partner (maks 6)
      const logos = ((item.partner_logo ?? '').toString().split(';')
        .map(s => s.trim()).filter(Boolean).slice(0, 6)
        .map(url => `
          <img src="${escapeAttr(url)}"
               class="col-auto rounded bg-body p-1 shadow-sm border"
               style="height:45px"
               loading="lazy"
               alt="partner_logo ${escapeAttr(institution)}">`).join(''));

      const badge = (val, prefix = '') => {
        const v = (val ?? '').toString().trim();
        return v ? `<span class="badge rounded p-2 me-2 mb-2 bg-secondary-subtle text-secondary-emphasis">${escapeHtml(prefix ? `${prefix} ${v}` : v)}</span>` : '';
      };

      // Format harga
		const rawHarga = parseFloat(item.harga || "0");
		const hargaFormatted = rawHarga === 0 
		  ? "Free" 
		  : rawHarga.toLocaleString("id-ID"); // format angka lokal Indonesia

      return `
        <div class="col-md-6 col-lg-3">
          <div class="card h-100 shadow-sm border rounded-4">
            <div class="ratio ratio-16x9 position-relative">
              <img src="${escapeAttr(item.card_image || DEFAULT_COVER)}"
                   loading="lazy"
                   class="object-fit-cover w-100 h-100 rounded-4 p-2"
                   alt="cover ${escapeAttr(courseName)}">
            </div>

            <div class="card-body pt-4">
              ${logos ? `
                <div class="row position-relative mb-1" style="margin-top:-4rem; margin-left:0.1rem; z-index:2;">
                  ${logos}
                </div>` : ''}

              <h5 class="card-title mb-1">${escapeHtml(courseName)}</h5>
              <h6 class="card-subtitle text-muted mb-3" style="font-size:1.05rem;">${escapeHtml(institution)}</h6>
              <h6 class="card-subtitle text-primary mb-3" style="font-size:1.05rem;">${hargaFormatted === "Free" ? '<span class="text-success fw-bold">Free</span>' : `${escapeHtml(hargaFormatted)} IDR`}</h6>

              <div class="d-flex flex-wrap">
                <span class="badge rounded p-2 me-2 mb-2 bg-secondary-subtle text-secondary-emphasis">${escapeHtml(start_date)}</span>
                <span class="badge rounded p-2 me-2 mb-2 bg-secondary-subtle text-secondary-emphasis">s/d</span>
                <span class="badge rounded p-2 me-2 mb-2 bg-secondary-subtle text-secondary-emphasis">${escapeHtml(end_date)}</span>
                ${badge(item.level)}${badge(item.pacing_or_type)}${badge(item.bahasa)}${badge(item.tipe)}${badge(item.platform)}
              </div>
            </div>

            <div class="card-footer bg-transparent border-0 pt-0 pb-3">
              <a class="btn btn-primary w-100"
                 href="${escapeAttr(item.course_url || '#')}"
                 target="_blank" rel="noopener">Course Detail</a>
            </div>
          </div>
        </div>`;
    }).join('');
  }

  function renderPagination() {
    const totalPages = Math.max(1, Math.ceil(total / itemsPerPage));
    const prevDisabled = currentPage === 1 ? "disabled" : "";
    const nextDisabled = currentPage >= totalPages ? "disabled" : "";
    el.pagination.innerHTML = `
      <li class="page-item ${prevDisabled}">
        <a class="page-link" href="#" onclick="return goPage(${currentPage - 1})">Sebelumnya</a>
      </li>
      <li class="page-item disabled">
        <a class="page-link" href="#">${currentPage} / ${totalPages}</a>
      </li>
      <li class="page-item ${nextDisabled}">
        <a class="page-link" href="#" onclick="return goPage(${currentPage + 1})">Berikutnya</a>
      </li>`;
  }
  window.goPage = function(n){
    if (n < 1) return false;
    const totalPages = Math.max(1, Math.ceil(total / itemsPerPage));
    if (n > totalPages) return false;
    loadPage(n);
    return false;
  };

  function updateDataInfo() {
    const start = total ? ((currentPage - 1) * itemsPerPage + 1) : 0;
    const end = Math.min(currentPage * itemsPerPage, total);
    el.info.textContent = `Menampilkan ${start} - ${end} dari ${total} data`;
  }

  // == LISTENERS ==
  let t = null;
  el.search.addEventListener("input", () => {
    clearTimeout(t);
    t = setTimeout(() => loadPage(1), 350); // debounce kecil
  });
  [el.fInstitution, el.fCategory, el.fPacing, el.fLevel, el.fKemampuan, el.fBahasa, el.fTipe, el.fPlatform, el.fHarga]
    .forEach(sel => sel.addEventListener("change", () => loadPage(1)));

  el.btnReset.addEventListener("click", () => {
    el.search.value = "";
    el.fInstitution.value = "";
    el.fCategory.value = "";
    el.fPacing.value = "";
    el.fLevel.value = "";
    el.fKemampuan.value = "";
    el.fBahasa.value = "";
    el.fTipe.value = "";
    el.fPlatform.value = "";
    el.fHarga.value = "";
    loadPage(1);
  });

  // == BOOT ==
  document.addEventListener("DOMContentLoaded", async () => {
    renderSkeleton();
    await loadMeta();
    await loadPage(1);
  });
</script>
  </body>
</html>
