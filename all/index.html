<html>
  <head>
    <title>Katalog All Courses ICE Institute</title>
    <script src="../load-components.js"></script>
    <script src="../load-head.js"></script>
    <style>
      .placeholder-card {
        height: 220px;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        background-color: #f8f9fa;
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0% { background-color: #f8f9fa; }
        50% { background-color: #e9ecef; }
        100% { background-color: #f8f9fa; }
      }
    </style>
  </head>
  <body>
    <div id="header"></div>

    <main class="container py-3">
      <div class="col-10 px-4 py-5 my-5 text-center mx-auto">
        <h1 class="display-5 fw-bold text-body-emphasis">Katalog ICE Institute</h1>
      </div>

      
      <h1 class="fw-bold text-body-emphasis">Search our catalog</h1>
      <div class="input-group mb-3">
		  <span class="input-group-text" id="basic-addon1"><i class="bi bi-search" style="font-size: 2rem;"></i></span>
		  <input type="text" id="searchInput" class="form-control form-control-lg" style="font-size: 2rem;">
		</div>

      <!-- FILTERS ROW -->
      <div class="row g-2 align-items-center mb-3" id="filtersRow" style="display:none;">
        <div class="col-12 col-md-4">
          <select id="filterInstitution" class="form-select">
            <option value="">Semua Institusi</option>
          </select>
        </div>
        <div class="col-12 col-md-4">
          <select id="filterCategory" class="form-select">
            <option value="">Semua Kategori</option>
          </select>
        </div>
        <div class="col-6 col-md-2">
          <select id="filterPacing" class="form-select">
            <option value="">Semua Tipe</option>
          </select>
        </div>
        <div class="col-6 col-md-2">
          <select id="filterLevel" class="form-select">
            <option value="">Semua Level</option>
          </select>
        </div>
        <div class="col-6 col-md-2">
          <select id="filterSkills" class="form-select">
            <option value="">Semua Skill</option>
          </select>
        </div>
        <div class="col-6 col-md-2">
          <select id="filterBahasa" class="form-select">
            <option value="">Semua Bahasa</option>
          </select>
        </div>
        <div class="col-12 col-md-2 d-grid">
          <button id="btnResetFilters" class="btn btn-outline-secondary">Reset</button>
        </div>
      </div>

      <div class="mb-2 text-end text-muted" id="dataInfo"></div>

      <div id="cardContainer" class="row g-4"></div>

      <nav class="mt-4">
        <ul class="pagination justify-content-center" id="pagination"></ul>
      </nav>
    </main>

    <div id="footer"></div>

    <script>
      const apiUrl = "https://script.google.com/macros/s/AKfycbwphVxeXWqOHpIhvAr8wlMqSYvErzNWtjS7kx0DtgZiXeAzNgCmJHMYrGdWs8q2l6neYQ/exec"; // URL GAS kamu
      let allData = [];
      let filteredData = [];
      const itemsPerPage = 12;
      let currentPage = 1;

      // Elemen
      const el = {
        search: document.getElementById("searchInput"),
        info: document.getElementById("dataInfo"),
        cards: document.getElementById("cardContainer"),
        pagination: document.getElementById("pagination"),
        filtersRow: document.getElementById("filtersRow"),
        fInstitution: document.getElementById("filterInstitution"),
        fCategory: document.getElementById("filterCategory"),
        fPacing: document.getElementById("filterPacing"),
        fLevel: document.getElementById("filterLevel"),
        fSkills: document.getElementById("filterSkills"),
        fBahasa: document.getElementById("filterBahasa"),
        btnReset: document.getElementById("btnResetFilters")
      };

      // Helper: lower-case aman
      const lc = v => (v ?? "").toString().toLowerCase();

      // Helper: ambil nilai unik terurut (single value)
      function uniqueValues(arr, key) {
        const s = new Set();
        arr.forEach(it => s.add((it?.[key] ?? "").toString().trim()));
        const list = Array.from(s).filter(v => v);
        list.sort((a,b) => a.localeCompare(b, 'id'));
        return list;
      }

      // Helper: ambil nilai unik terurut, split ';'
      function uniqueValuesSplit(arr, key) {
        const s = new Set();
        arr.forEach(it => {
          const raw = (it?.[key] ?? '').toString();
          raw.split(';').forEach(part => {
            const v = part.trim();
            if (v) s.add(v);
          });
        });
        return Array.from(s).sort((a,b) => a.localeCompare(b, 'id'));
      }

      async function fetchData() {
        try {
          const res = await fetch(apiUrl);
          const data = await res.json();
          allData = Array.isArray(data) ? data : [];
          populateFilters(allData);
          applyFiltersAndRender(1);
        } catch (err) {
          el.cards.innerHTML = "<p class='text-danger'>Gagal memuat data.</p>";
          console.error(err);
        }
      }

      function populateFilters(data) {
        // Institution, Category, Level, Skills -> split ';' (multi-value)
        const institutions = uniqueValuesSplit(data, "institution");
        const categories   = uniqueValuesSplit(data, "category");
        const levels       = uniqueValuesSplit(data, "level");
        const skills       = uniqueValuesSplit(data, "skill");

        // Pacing & Bahasa tetap single value (kalau perlu bisa di-split juga)
        const pacings      = uniqueValues(data, "pacing_or_type");
        const bahasas      = uniqueValues(data, "bahasa");

        const hasAny = institutions.length || categories.length || pacings.length || levels.length || skills.length || bahasas.length;
        el.filtersRow.style.display = hasAny ? "" : "none";

        fillSelect(el.fInstitution, institutions, "Semua Institusi");
        fillSelect(el.fCategory, categories, "Semua Kategori");
        fillSelect(el.fPacing, pacings, "Semua Tipe");
        fillSelect(el.fLevel, levels, "Semua Level");
        fillSelect(el.fSkills, skills, "Semua Skill");
        fillSelect(el.fBahasa, bahasas, "Semua Bahasa");
      }

      function fillSelect(selectEl, values, placeholder) {
        const current = selectEl.value;
        const opts = ['<option value="">' + placeholder + '</option>']
          .concat(values.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`));
        selectEl.innerHTML = opts.join("");
        if (values.includes(current)) selectEl.value = current;
      }

      function applyFiltersAndRender(page = 1) {
        // Kondisi dari UI
        const kw        = lc(el.search.value);
        const instSel   = lc(el.fInstitution.value);
        const catSel    = lc(el.fCategory.value);
        const paceSel   = lc(el.fPacing.value);
        const levelSel  = lc(el.fLevel.value);
        const skillSel  = lc(el.fSkills.value);
        const bahasaSel = lc(el.fBahasa.value);

        filteredData = allData.filter(item => {
          // Search global
          const matchesSearch = !kw || (
            lc(item.course_name).includes(kw) ||
            lc(item.institution).includes(kw) ||
            lc(item.category).includes(kw) ||
            lc(item.skills).includes(kw)
          );

          // Institution (multi)
          const instParts = (item.institution ?? '').toString().split(';').map(s => lc(s.trim())).filter(Boolean);
          const matchesInst = !instSel || instParts.includes(instSel);

          // Category (multi)
          const catParts = (item.category ?? '').toString().split(';').map(s => lc(s.trim())).filter(Boolean);
          const matchesCat = !catSel || catParts.includes(catSel);

          // Level (multi)
          const levelParts = (item.level ?? '').toString().split(';').map(s => lc(s.trim())).filter(Boolean);
          const matchesLevel = !levelSel || levelParts.includes(levelSel);

          // Skills (multi)
          const skillParts = (item.skill ?? '').toString().split(';').map(s => lc(s.trim())).filter(Boolean);
          const matchesSkill = !skillSel || skillParts.includes(skillSel);

          // Pacing & Bahasa (single / exact)
          const matchesPace = !paceSel || lc(item.pacing_or_type) === paceSel;
          const matchesBahasa = !bahasaSel || lc(item.bahasa) === bahasaSel;

          return matchesSearch && matchesInst && matchesCat && matchesLevel && matchesSkill && matchesPace && matchesBahasa;
        });

        renderPage(page);
      }

      function renderPage(page) {
        currentPage = page;
        const start = (page - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageItems = filteredData.slice(start, end);

        const DEFAULT_COVER = 'https://iceinstitut.github.io/image/aset/cover-default.jpg';

        el.cards.innerHTML = pageItems.map(item => {
          const courseName = (item.course_name ?? '').toString();
          const institution = (item.institution ?? '').toString();

          // Logo partner (maks 6)
          const logos = ((item.partner_logo ?? '').toString().split(';')
            .map(s => s.trim())
            .filter(Boolean)
            .slice(0, 6)
            .map(url => `
              <img src="${escapeAttr(url)}"
                   class="rounded bg-body p-1 shadow-sm border"
                   style="height:32px"
                   loading="lazy"
                   alt="partner_logo ${escapeAttr(institution)}">
            `).join(''));

          // Badge helper
          const badge = (val, prefix = '') => {
            const v = (val ?? '').toString().trim();
            return v ? `<span class="badge rounded p-2 me-2 mb-2 bg-secondary-subtle text-secondary-emphasis">${escapeHtml(prefix ? `${prefix} ${v}` : v)}</span>` : '';
          };

          return `
            <div class="col-md-6 col-lg-3">
              <div class="card h-100 shadow-sm border rounded-4">
                <!-- Cover + overlay logo -->
                <div class="ratio ratio-16x9 position-relative">
                  <img src="${escapeAttr(item.card_image || DEFAULT_COVER)}"
                       loading="lazy"
                       class="object-fit-cover w-100 h-100 rounded-4 p-2"
                       alt="cover ${escapeAttr(courseName)}">
                  ${
                    logos
                      ? `
                        <div class="position-absolute d-flex flex-wrap gap-1"
                             style="left:.50rem; bottom:0; transform:translateY(90%); z-index:2;">
                          ${logos}
                        </div>
                      `
                      : ''
                  }
                </div>

                <div class="card-body pt-4">
                  <h5 class="card-title mb-1">${escapeHtml(courseName)}</h5>
                  <h6 class="card-subtitle text-muted mb-3" style="font-size:1.05rem;">${escapeHtml(institution)}</h6>
                  <div class="d-flex flex-wrap">
                    ${badge(item.start_date)}
                    ${badge(item.end_date, 'Course :')}
                    ${badge(item.level)}
                    ${badge(item.pacing_or_type)}
                    ${badge(item.bahasa)}
                    ${badge(item.tipe)}
                    ${badge(item.platform)}
                  </div>
                </div>

                <div class="card-footer bg-transparent border-0 pt-0 pb-3">
                  <a class="btn btn-light w-100"
                     href="${escapeAttr(item.course_url || '#')}"
                     target="_blank" rel="noopener">
                     Course Detail
                  </a>
                </div>
              </div>
            </div>
          `;
        }).join('');

        renderPagination();
        updateDataInfo(start, end, filteredData.length, allData.length);
      }

      function renderPagination() {
        const totalPages = Math.max(1, Math.ceil(filteredData.length / itemsPerPage));
        const prevDisabled = currentPage === 1 ? "disabled" : "";
        const nextDisabled = currentPage >= totalPages ? "disabled" : "";
        el.pagination.innerHTML = `
          <li class="page-item ${prevDisabled}">
            <a class="page-link" href="#" onclick="return goPage(${currentPage - 1})">Sebelumnya</a>
          </li>
          <li class="page-item disabled">
            <a class="page-link" href="#">${currentPage} / ${totalPages}</a>
          </li>
          <li class="page-item ${nextDisabled}">
            <a class="page-link" href="#" onclick="return goPage(${currentPage + 1})">Berikutnya</a>
          </li>
        `;
      }

      // pagination handler
      window.goPage = function(n) {
        if (n < 1) return false;
        const totalPages = Math.max(1, Math.ceil(filteredData.length / itemsPerPage));
        if (n > totalPages) return false;
        renderPage(n);
        return false;
      };

      function updateDataInfo(start, end, totalFiltered, totalAll) {
        const shownEnd = Math.min(end, totalFiltered);
        el.info.textContent = `Menampilkan ${totalFiltered ? (start + 1) : 0} - ${shownEnd} dari ${totalFiltered} data â€¢ Total ${totalAll}`;
      }

      // escape
      function escapeHtml(str) {
        return String(str ?? '')
          .replaceAll('&','&amp;')
          .replaceAll('<','&lt;')
          .replaceAll('>','&gt;')
          .replaceAll('"','&quot;')
          .replaceAll("'","&#039;");
      }
      function escapeAttr(str){ return escapeHtml(str).replaceAll('\n',' '); }

      // Listeners
      el.search.addEventListener("input", () => applyFiltersAndRender(1));
      el.fInstitution.addEventListener("change", () => applyFiltersAndRender(1));
      el.fCategory.addEventListener("change", () => applyFiltersAndRender(1));
      el.fPacing.addEventListener("change", () => applyFiltersAndRender(1));
      el.fLevel.addEventListener("change", () => applyFiltersAndRender(1));
      el.fSkills.addEventListener("change", () => applyFiltersAndRender(1));
      el.fBahasa.addEventListener("change", () => applyFiltersAndRender(1));
      el.btnReset.addEventListener("click", () => {
        el.search.value = "";
        el.fInstitution.value = "";
        el.fCategory.value = "";
        el.fPacing.value = "";
        el.fLevel.value = "";
        el.fSkills.value = "";
        el.fBahasa.value = "";
        applyFiltersAndRender(1);
      });

      // Placeholder skeleton sebelum fetch
      document.addEventListener("DOMContentLoaded", () => {
        el.cards.innerHTML = Array.from({ length: 12 }).map(() => `
          <div class="col-md-6 col-lg-3">
            <div class="placeholder-card p-3"></div>
          </div>
        `).join("");
        fetchData();
      });
    </script>
  </body>
</html>

