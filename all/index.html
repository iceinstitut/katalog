<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="https://iceinstitut.github.io/image/aset/favicon_icei.png" type="image/png">
  <title>Katalog ICE Institute</title>

  <script>
    function loadComponent(id, url) {
      fetch("https://iceinstitut.github.io/konten/" + url)
        .then(response => response.text())
        .then(data => {
          document.getElementById(id).innerHTML = data;
        });
    }

    document.addEventListener("DOMContentLoaded", function() {
      loadComponent("header", "header.html");
      loadComponent("footer", "footer.html");
    });

    fetch("https://iceinstitut.github.io/konten/head.html")
      .then(response => response.text())
      .then(data => {
        const temp = document.createElement("div");
        temp.innerHTML = data;

        // Proses <link> langsung
        temp.querySelectorAll("link").forEach(link => {
          document.head.appendChild(link);
        });

        // Proses <script> manual
        temp.querySelectorAll("script").forEach(oldScript => {
          const newScript = document.createElement("script");
          newScript.src = oldScript.src;
          if (oldScript.defer) newScript.defer = true;
          document.head.appendChild(newScript);
        });
      });
  </script>

  <style>
    :root{
      --brand:#ee1522;
      --soft:#f6f7fb;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --shadow: 0 10px 30px rgba(17,24,39,.08);
      --shadow-sm: 0 6px 16px rgba(17,24,39,.08);
      --radius:16px;
      --focus: 0 0 0 4px rgba(238,21,34,.18);
      --max:1200px;
      --ratio: 1.618;
      --ukuranfont :12px;
      --ukuranfont1 :calc(var(--ukuranfont) * var(--ratio));
      --ukuranfont2 :calc(var(--ukuranfont1) * var(--ratio));
      --ukuranfont3 :calc(var(--ukuranfont2) * var(--ratio));
      --ukuranfont4 :calc(var(--ukuranfont3) * var(--ratio));
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      /*background:linear-gradient(180deg, #fff 0%, #fff 35%, var(--soft) 100%);*/
      background: #f6f6f6;
      color:var(--text);
      font-size: var(--ukuranfont);
    }
    a{color:inherit}
    .wrap{max-width:var(--max); margin:0 auto; padding:20px 16px 40px}

    /* Top */
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 0 0}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none}
    .brand__dot{width:14px;height:14px;border-radius:6px;background:var(--brand); box-shadow:0 10px 24px rgba(238,21,34,.25)}
    .brand__name{font-weight:800; letter-spacing:.2px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border:1px solid var(--line); border-radius:999px;
      background:rgba(255,255,255,.75);
      color:var(--muted); font-size:13px; backdrop-filter: blur(8px);
    }
    .pill b{color:var(--text)}

    /* Hero */
    .hero{
      margin-top:16px;
      border:1px solid var(--line);
      border-radius:calc(var(--radius) + 6px);
      box-shadow: var(--shadow);
      padding:20px 16px;
      overflow:hidden;
      background: #ffffff;
    }
    .hero__grid{display:grid; grid-template-columns: 1.4fr .6fr; gap:16px; align-items:center; font-weight: bold;}
    .hero h1{margin:0; font-size:var(--ukuranfont4); line-height:1.12; letter-spacing:-.3px; color: var(--brand)}
    .hero p{margin:10px 0 0; color:var(--muted); line-height:1.55; max-width:56ch}
    .hero__badgeRow{display:flex; flex-wrap:wrap; gap:10px; margin-top:14px}
    .hero__badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:9px 12px; border-radius:999px; border:1px solid var(--line);
      background:rgba(255,255,255,.85); font-size:var(--ukuranfont1); color:var(--muted);
    }
    .hero__badge i{width:10px;height:10px;border-radius:4px;background:var(--brand); display:inline-block}

    .notice{
      border:1px solid var(--line);
      background: rgba(255,255,255,.85);
      border-radius: var(--radius);
      padding:12px;
      color:var(--muted);
      font-size:13px;
    }
    .spinner{
      display:inline-block;
      width:14px; height:14px;
      border:2px solid rgba(107,114,128,.35);
      border-top-color: rgba(238,21,34,.9);
      border-radius:50%;
      animation: spin .8s linear infinite;
      vertical-align:-2px;
      margin-right:8px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Quick Fakultas */
    .quickWrap{
      margin-top:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.9);
      border-radius:calc(var(--radius) + 6px);
      box-shadow: var(--shadow-sm);
      padding:12px;
    }
    .quickHead{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:30px}
    .quickHead .t{font-size:13px; color:var(--muted); font-weight:900; letter-spacing:.08em; text-transform:uppercase; margin:0}
    .quickRow{display:flex; gap:10px; flex-wrap:wrap}
    .qbtn{
      display:inline-flex; align-items:center; justify-content:center;
      gap:10px;
      padding:10px 15px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      font-weight:900;
      font-size: var(--ukuranfont1);
      cursor:pointer;
      transition: box-shadow .15s, border-color .15s, transform .05s ease;
      user-select:none; white-space:nowrap;
    }
    .qbtn:hover{border-color: rgba(238,21,34,.35); box-shadow:0 10px 18px rgba(17,24,39,.08)}
    .qbtn:active{transform: translateY(1px)}
    .qbtn.active{
      background: rgba(238,21,34,.10);
      border-color: rgba(238,21,34,.45);
      color: rgba(238,21,34,.95);
      box-shadow: 0 14px 24px rgba(238,21,34,.12);
    }
    .qico{
      width:36px; height:36px;
      padding: 5px;
      border-radius:999px;
      display:inline-flex; align-items:center; justify-content:center;
      border:1px solid rgba(238,21,34,.18);
      background: rgba(238,21,34,.06);
      flex:0 0 auto;
    }
    .qico svg{display:block}
    .qlabel{display:flex; flex-direction:column; line-height:1.05}
    .qlabel small{font-weight:800; font-size:11px; color:var(--muted); margin-top:2px}

    /* Search */
    .searchBlock{
      margin-top:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.9);
      border-radius:calc(var(--radius) + 6px);
      box-shadow: var(--shadow-sm);
      padding:14px;
    }
    .cari {font-size: var(--ukuranfont2); margin-bottom: 14px; font-weight: bold;}
    .searchRow{display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:stretch; height: 60px;}
    .searchInput{
      width:100%;
      font-size:16px;
      padding:14px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      outline:none;
      background:#fff;
      transition: box-shadow .15s, border-color .15s;
    }
    .searchInput:focus{box-shadow:var(--focus); border-color: rgba(238,21,34,.55)}
    .wrap .btn{
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      border-radius:14px;
      padding:12px 14px;
      font-weight:700;
      cursor:pointer;
      transition: transform .05s ease, box-shadow .15s, border-color .15s;
      white-space:nowrap;
    }
    .wrap .btn:hover{border-color: rgba(238,21,34,.35); box-shadow:0 10px 22px rgba(17,24,39,.08)}
    .wrap .btn:active{transform: translateY(1px)}
    .wrap .btn--brand{
      background: var(--brand);
      border-color: rgba(238,21,34,.35);
      color:#fff;
      box-shadow: 0 14px 26px rgba(238,21,34,.22);
    }
    .wrap .btn--brand:hover{box-shadow:0 18px 32px rgba(238,21,34,.26)}
    .subRow{
      margin-top:10px;
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;
      color:var(--muted); font-size:13px;
    }
    .subRow .left{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    .chip{
      display:inline-flex; gap:8px; align-items:center;
      padding:7px 10px; border-radius:999px;
      border:1px dashed rgba(238,21,34,.35);
      background: rgba(238,21,34,.06);
      color: rgba(238,21,34,.95);
      font-weight:900;
    }

    /* Filters */
    .panel{
      margin-top:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.9);
      border-radius:calc(var(--radius) + 6px);
      box-shadow: var(--shadow-sm);
      padding:14px;
    }
    .panelHead{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px}
    .panelHead h2{margin:0; font-size:14px; color:var(--muted); font-weight:900; letter-spacing:.12em; text-transform:uppercase}
    .filters{display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap:10px}
    .wrap .field{display:flex; flex-direction:column; gap:6px}
    .wrap .label{font-size:12px; color:var(--muted); font-weight:800}
    .wrap select, input[type="number"]{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      outline:none;
    }
    .wrap select:focus, input[type="number"]:focus{box-shadow:var(--focus); border-color: rgba(238,21,34,.55)}
    .rangeRow{display:grid; grid-template-columns: 1fr 1fr; gap:10px}

    /* Result head + inline loading */
    .gridHead{margin-top:14px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between}
    .gridHead .title{display:flex; align-items:center; gap:10px}
    .gridHead .title h3{margin:0; font-size:16px}
    .count{color:var(--muted); font-size:13px}

    .inlineLoading{
      margin-top:10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.85);
      border-radius: calc(var(--radius) + 6px);
      padding:10px 12px;
      display:none;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      box-shadow: var(--shadow-sm);
    }
    .inlineLoading.show{display:flex}
    .inlineLoading .left{
      display:flex; align-items:center; gap:10px;
      color:var(--muted); font-size:13px;
    }
    .inlineLoading .bar{
      flex:1;
      height:8px;
      border-radius:999px;
      background: rgba(17,24,39,.06);
      overflow:hidden;
      border:1px solid rgba(17,24,39,.06);
      min-width:120px;
    }
    .inlineLoading .bar i{
      display:block;
      height:100%;
      width:40%;
      border-radius:999px;
      background: rgba(238,21,34,.32);
      animation: slide 1.1s ease-in-out infinite;
    }
    @keyframes slide{
      0%{transform:translateX(-120%)}
      50%{transform:translateX(120%)}
      100%{transform:translateX(260%)}
    }

    /* Cards grid */
    .wrap .row{display:flex; flex-wrap:wrap; margin: 8px -8px 0}
    .wrap .col-4{width:33.33%; padding:8px}
    .wrap .card{
      border:1px solid var(--line);
      background:rgba(255,255,255,.94);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: 0 12px 26px rgba(17,24,39,.06);
      display:flex; flex-direction:column; min-height:100%;
    }
    .wrap .media{
      position:relative; width:100%; aspect-ratio: 16 / 9;
      background: linear-gradient(180deg, rgba(238,21,34,.06), rgba(17,24,39,.02));
      overflow:hidden; border-bottom:1px solid var(--line);
    }
    .wrap .media img{position:absolute; inset:0; width:100%; height:100%; object-fit:cover; display:block}
    .wrap .media .imgFallback{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      color:var(--muted); font-size:13px; padding:10px; text-align:center;
    }
    .wrap .body{padding:12px 12px 12px; display:flex; flex-direction:column; gap:10px; flex:1}
    .logosTop{display:flex; flex-wrap:wrap; gap:8px; padding-top:2px}
    .logosTop img{
      height:64px; width:auto; background:#fff; border:1px solid var(--line);
      border-radius:10px; padding:3px 6px;
    }
    .headline{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
    .subheadline{color:var(--muted); font-size:12px; display:flex; flex-wrap:wrap; gap:8px}
    .course{margin:0; font-size:15px; line-height:1.25; font-weight:900; letter-spacing:-.2px}
    .money{padding: 6px 9px; border-radius: 999px; border: 1px solid rgba(238, 21, 34, .95); font-weight: 900; color: rgba(238, 21, 34, .95); font-size: 12px; white-space: nowrap; margin-top: 2px}
    .money.free{padding: 6px 9px; border-radius: 999px; border: 1px solid #16a34a; color: #16a34a;)}
    .meta{color:var(--muted); font-size:12px; display:flex; flex-wrap:wrap; gap:8px}
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 9px; border-radius:999px; border:1px solid var(--line);
      background:#fff; font-size:12px; color:var(--muted); max-width:100%;
    }
    .tag b{color:var(--text)}
    .tag--brand{
      border-color: rgba(238,21,34,.25);
      /*background: rgba(238,21,34,.06);
      color: rgba(238,21,34,.95);*/
      font-weight:900;
    }
    .kv{display:grid; grid-template-columns: 1fr; gap:7px; font-size:12px; color:var(--muted)}
    .kv .line{display:flex; gap:8px}
    .kv .k{min-width:110px; color:var(--text); font-weight:900}
    .kv .v{flex:1; overflow:hidden; text-overflow:ellipsis}
    .kv .v.small{font-size:12px}

    .cardFoot{padding:0 12px 12px; display:flex}
    .linkBtn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:12px 12px;
      border-radius:14px;
      background:#fff;
      border:1px solid var(--line);
      font-weight:900;
      text-decoration:none;
      cursor:pointer;
      transition: box-shadow .15s, border-color .15s, transform .05s ease;
      width:100%;
    }
    .linkBtn:hover{border-color: rgba(238,21,34,.35); box-shadow:0 10px 18px rgba(17,24,39,.08)}
    .linkBtn:active{transform: translateY(1px)}
    .linkBtn--brand{
      background: var(--brand);
      color:#fff;
      border-color: rgba(238,21,34,.4);
      box-shadow: 0 14px 26px rgba(238,21,34,.18);
    }

    .loadMoreWrap{margin-top:14px; display:flex; justify-content:center}

    /* Responsive */
    @media (max-width: 980px){
      .hero__grid{grid-template-columns:1fr}
      .filters{grid-template-columns:repeat(2,minmax(0,1fr))}
      .searchRow{grid-template-columns:1fr}
      .wrap .col-4{width:50%}
    }
    @media (max-width: 680px){
      .pill{display:none}
      .wrap{padding:16px 12px 34px}
      .hero{padding:18px 14px}
      .quickRow{
        flex-wrap:nowrap; overflow:auto; padding-bottom:2px;
        -webkit-overflow-scrolling: touch; scroll-snap-type:x proximity;
      }
      .qbtn{scroll-snap-align:start}
      .qlabel small{display:none}
    }

    .hide {display: none ! IMPORTANT;}
    @media (max-width: 560px){ .col-4{width:100%} }
    @media (max-width: 520px){ .filters{grid-template-columns:1fr} }
  </style>
</head>

<body>
<div id="header"></div>
  <div class="wrap">
    <div class="topbar hide">
      <a class="brand" href="#" onclick="return false;">
        <span class="brand__dot"></span>
        <span class="brand__name">ICE Institute — Katalog</span>
      </a>
      <span class="pill">Sumber: <b>API</b> • Tema <b>#ee1522</b></span>
    </div>

    <!-- HERO -->
    <section class="hero" aria-label="Hero">
      <div class="hero__grid">
        <div>
          <h1>Explore world-class learning with<br>ICE Institute</h1>
          <p class="hide">
            Unmatched quality. Market relevance. Comprehensive solutions.
          </p>
          <div class="hero__badgeRow">
            <span class="hero__badge"><i></i> Unmatched quality</span>
            <span class="hero__badge"><i></i> Market relevance</span>
            <span class="hero__badge"><i></i> Comprehensive solutions</span>
          </div>
        </div>
        <div class="notice hide" id="statusBox">
          <span class="spinner" aria-hidden="true"></span>
          Loading catalog data…
        </div>
      </div>
    </section>

    <!-- QUICK FILTER (setelah hero) -->
    <section class="quickWrap hide" aria-label="Quick Fakultas">
      <div class="quickHead">
        <div class="t">Quick Filter Fakultas</div>
        <!-- <div class="pill">Match: <b>contains</b> (aman untuk data delimiter)</div> -->
        <div class="pill">Klik Nama Fakultas untuk mengaktifkan, dan klik lagi untuk menon aktifkan</div>
      </div>
      <div class="quickRow" id="quickFakultas"></div>
    </section>

    <!-- SEARCH BESAR -->
    <section class="searchBlock" aria-label="Search">
      <div class="cari">Search our catalog</div>
      <div class="searchRow">
        <input id="q" class="searchInput" type="search"
          placeholder="Search our catalog"
          autocomplete="off" />
        <button class="btn btn--brand" id="btnReset" title="Reset search & filter">Reset</button>
      </div>
      <div class="subRow">
        <div class="left">
          <span class="chip" id="chipCount">0 item</span>
          <!-- <span>Search pakai <b>search_index</b> (kolom 18).</span> -->
        </div>
        <div>
          <span class="pill">Load More: <b>12</b> item</span>
        </div>
      </div>
    </section>

    <!-- FILTER -->
    <section class="panel" aria-label="Filter">
      <div class="panelHead">
        <h2>Filter</h2>
        <div class="pill"><b id="activeFilters">0</b> active filter</div>
      </div>

      <div class="filters">
        <div class="field">
          <div class="label">Institution</div>
          <select id="f_institution"><option value="">All</option></select>
        </div>

        <div class="field">
          <div class="label">Level</div>
          <select id="f_level"><option value="">All</option></select>
        </div>

        <div class="field">
          <div class="label">Pacing</div>
          <select id="f_pacing"><option value="">All</option></select>
        </div>

        <div class="field">
          <div class="label">Language</div>
          <select id="f_bahasa"><option value="">All</option></select>
        </div>

        <div class="field">
          <div class="label">Category</div>
          <select id="f_category"><option value="">All</option></select>
        </div>

        <div class="field">
          <div class="label">Skills</div>
          <select id="f_kemampuan"><option value="">All</option></select>
        </div>

        <div class="field">
          <div class="label">Type</div>
          <select id="f_tipe"><option value="">All</option></select>
        </div>

        <div class="field hide">
          <div class="label">Platform</div>
          <select id="f_platform"><option value="">All</option></select>
        </div>

        <div class="field hide">
          <div class="label">Skala Institution</div>
          <select id="f_skala"><option value="">All</option></select>
        </div>

        <div class="field hide">
          <div class="label">Fakultas</div>
          <!-- opsi fakultas: split ; + unique -->
          <select id="f_fakultas"><option value="">All</option></select>
        </div>

        <div class="field">
          <div class="label">Price</div>
          <select id="f_harga">
            <option value="">All</option>
            <option value="FREE">Free</option>
            <option value="PAID">Paid</option>
          </select>
        </div>

        <div class="field">
          <div class="label">Duration (Hours)</div>
          <div class="rangeRow">
            <input id="f_dur_min" type="number" min="0" step="1" placeholder="Min" />
            <input id="f_dur_max" type="number" min="0" step="1" placeholder="Max" />
          </div>
        </div>
      </div>
    </section>

    <!-- CARDS -->
    <div class="gridHead" aria-label="Hasil">
      <div class="title">
        <h3>Result</h3>
        <span class="count" id="resultInfo">—</span>
      </div>
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <select id="sortBy" style="padding:10px 12px; border-radius:14px; border:1px solid var(--line); background:#fff;">
          <option value="relevance">Sort: Relevansi (Search)</option>
          <option value="name_asc">Name: A → Z</option>
          <option value="name_desc">Name: Z → A</option>
          <option value="dur_asc">Duration: Low → High</option>
          <option value="dur_desc">Duration: High → Low</option>
          <option value="price_asc">Price: Low → High</option>
          <option value="price_desc">Price: High → Low</option>
        </select>
      </div>
    </div>

    <!-- INLINE LOADING (di atas card) -->
    <div class="inlineLoading" id="inlineLoading">
      <div class="left">
        <span class="spinner" aria-hidden="true"></span>
        <span id="inlineLoadingText">Memproses…</span>
      </div>
      <div class="bar" aria-hidden="true"><i></i></div>
    </div>

    <div class="row" id="cards"></div>

    <!-- LOAD MORE -->
    <div class="loadMoreWrap">
      <button class="btn" id="btnMore" style="min-width:220px;">Load More</button>
    </div>
  </div>

<script>
(() => {
  const API_URL = "https://katalog.ice-institut.workers.dev/";
  const COLS = [
    "course_name","institution","start_date","end_date","level","pacing_or_type",
    "course_url","bahasa","category","kemampuan","course_id","card_image",
    "partner_logo","tipe","platform","skala_institution",
    "course_nameinstitutiontipeplatform","search_index","fakultas",
    "harga","duration_hours","kategori_digdaya"
  ];

  // Quick faculty buttons (sesuai permintaan)
  const QUICK_FAKULTAS = ["FEB","FKIP","FST","FHISIP","SPS","SV"];

  const el = (id) => document.getElementById(id);

  // Inline loading (NOT overlay)
  const inlineLoading = el("inlineLoading");
  const inlineLoadingText = el("inlineLoadingText");
  let loadingDepth = 0;
  let loadingTimer = null;

  function showLoading(msg="Memproses…"){
    loadingDepth++;
    inlineLoadingText.textContent = msg;

    // anti-flicker
    if (!loadingTimer){
      loadingTimer = setTimeout(() => {
        inlineLoading.classList.add("show");
      }, 120);
    }
  }
  function hideLoading(){
    loadingDepth = Math.max(0, loadingDepth - 1);
    if (loadingDepth === 0){
      if (loadingTimer){
        clearTimeout(loadingTimer);
        loadingTimer = null;
      }
      requestAnimationFrame(() => inlineLoading.classList.remove("show"));
    }
  }

  // UI refs
  const statusBox = el("statusBox");
  const q = el("q");
  const cards = el("cards");
  const btnMore = el("btnMore");
  const btnReset = el("btnReset");
  const chipCount = el("chipCount");
  const resultInfo = el("resultInfo");
  const activeFilters = el("activeFilters");
  const sortBy = el("sortBy");
  const quickFakultas = el("quickFakultas");

  const filters = {
    institution: el("f_institution"),
    level: el("f_level"),
    pacing_or_type: el("f_pacing"),
    bahasa: el("f_bahasa"),
    category: el("f_category"),
    kemampuan: el("f_kemampuan"),
    tipe: el("f_tipe"),
    platform: el("f_platform"),
    skala_institution: el("f_skala"),
    fakultas: el("f_fakultas"),
    harga: el("f_harga"),
    dur_min: el("f_dur_min"),
    dur_max: el("f_dur_max"),
  };

  // State
  let raw = [];
  let filtered = [];
  let visible = 12;

  // Quick filter state: contains-match (case-insensitive)
  let quickFaculty = ""; // e.g. "FEB"

  const norm = (v) => String(v ?? "").trim();
  const lower = (v) => norm(v).toLowerCase();

  function splitSemi(v){
    const s = norm(v);
    if (!s) return [];
    return s.split(";").map(x => x.trim()).filter(Boolean);
  }
  function uniqueSorted(arr){
    return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>a.localeCompare(b, "id", {sensitivity:"base"}));
  }
  function toNumber(v){
    const n = Number(String(v ?? "").replace(/[^\d.-]/g,""));
    return Number.isFinite(n) ? n : 0;
  }
  function priceLabel(price){
    const n = toNumber(price);
    return n <= 0 ? "Free" : new Intl.NumberFormat("id-ID", {style:"currency", currency:"IDR", maximumFractionDigits:0}).format(n);
  }
  function priceBucket(price){
    const n = toNumber(price);
    return n <= 0 ? "FREE" : "PAID";
  }
  function safeUrl(u){
    const s = norm(u);
    if (!s) return "";
    try{
      const url = new URL(s);
      if (url.protocol === "http:" || url.protocol === "https:") return url.toString();
      return "";
    }catch(e){ return ""; }
  }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function countActiveFilters(){
    let n = 0;
    const keys = ["institution","level","pacing_or_type","bahasa","category","kemampuan","tipe","platform","skala_institution","fakultas","harga"];
    keys.forEach(k => { if (filters[k].value) n++; });
    if (norm(filters.dur_min.value)) n++;
    if (norm(filters.dur_max.value)) n++;
    if (norm(q.value)) n++;
    if (norm(quickFaculty)) n++; // quick filter aktif
    return n;
  }

  function scoreSearch(it, query){
    const si = lower(it.search_index);
    const qq = lower(query);
    if (!qq) return 0;
    let score = 0;
    const terms = qq.split(/\s+/).filter(Boolean);
    for (const t of terms){
      if (si === t) score += 50;
      if (si.includes(t)) score += 10;
    }
    if (si.startsWith(qq)) score += 25;
    return score;
  }

  function kvLine(key, value, small=false){
    const wrap = document.createElement("div");
    const line = document.createElement("div");
    line.className = "line";
    const k = document.createElement("div");
    k.className = "k";
    k.textContent = key;
    const v = document.createElement("div");
    v.className = "v" + (small ? " small" : "");
    v.textContent = value;
    line.appendChild(k);
    line.appendChild(v);
    wrap.appendChild(line);
    return wrap;
  }

  function renderCard(it){
    const col = document.createElement("div");
    col.className = "col-4";

    const card = document.createElement("article");
    card.className = "card";

    const media = document.createElement("div");
    media.className = "media";

    const imgUrl = safeUrl(it.card_image);
    if (imgUrl){
      const img = document.createElement("img");
      img.alt = norm(it.course_name) || "Gambar";
      img.loading = "lazy";
      img.src = imgUrl;
      img.onerror = () => {
        media.innerHTML = "";
        const fb = document.createElement("div");
        fb.className = "imgFallback";
        fb.textContent = "Gambar tidak tersedia";
        media.appendChild(fb);
      };
      media.appendChild(img);
    } else {
      const fb = document.createElement("div");
      fb.className = "imgFallback";
      fb.textContent = "Gambar tidak tersedia";
      media.appendChild(fb);
    }

    const body = document.createElement("div");
    body.className = "body";

    // partner_logo ABOVE title
    const logosWrap = document.createElement("div");
    logosWrap.className = "logosTop";
    const logos = splitSemi(it.partner_logo).map(safeUrl).filter(Boolean);
    if (logos.length){
      for (const u of logos){
        const lg = document.createElement("img");
        lg.loading = "lazy";
        lg.alt = "Partner Logo";
        lg.src = u;
        lg.onerror = () => lg.remove();
        logosWrap.appendChild(lg);
      }
    } else {
      const none = document.createElement("span");
      none.className = "tag";
      none.textContent = "Partner logo: -";
      logosWrap.appendChild(none);
    }

    const headline = document.createElement("div");
    headline.className = "headline";

    const h = document.createElement("h4");
    h.className = "course";
    h.textContent = norm(it.course_name) || "-";

    const price = document.createElement("div");
    const isFree = priceBucket(it.harga) === "FREE";
    price.className = "money" + (isFree ? " free" : "");
    price.textContent = isFree ? "Free" : priceLabel(it.harga);

    headline.appendChild(h);
    headline.appendChild(price);

    const subheadline = document.createElement("div");
    subheadline.className = "subheadline";

    const inst = document.createElement("span");
    inst.className = "tag--brand";
    inst.textContent = norm(it.institution) ? splitSemi(it.institution).join("; ") : "-";

    subheadline.appendChild(inst);

    const meta = document.createElement("div");
    meta.className = "meta";

    const tipe = document.createElement("span");
    tipe.className = "tag";
    tipe.innerHTML = `<b>Type:</b> ${escapeHtml(norm(it.tipe) || "-")}`;

    const plat = document.createElement("span");
    plat.className = "tag";
    plat.innerHTML = `<b class="hide">Platform:</b> ${escapeHtml(norm(it.platform) || "-")}`;

    const lang = document.createElement("span");
    lang.className = "tag";
    lang.innerHTML = `<b>Language:</b> ${escapeHtml(norm(it.bahasa) || "-")}`;

    const tgl = document.createElement("span");
    tgl.className = "tag";
    tgl.innerHTML = `<b>Schedule:</b> ${norm(it.start_date)||"-"} → ${norm(it.end_date)||"-"}`;

    const lev = document.createElement("span");
    lev.className = "tag";
    lev.innerHTML = `<b>Level:</b> ${escapeHtml(norm(it.level) || "-")}`;

    const paced = document.createElement("span");
    paced.className = "tag";
    paced.innerHTML = `<b>Pacing:</b> ${escapeHtml(norm(it.pacing_or_type) || "-")}`;

    const ska = document.createElement("span");
    ska.className = "tag";
    ska.innerHTML = `<b class="hide">Skala:</b> ${escapeHtml(norm(it.skala_institution) || "-")}`;

    const dur = document.createElement("span");
    dur.className = "tag";
    dur.innerHTML = `<b>Duration:</b> ${toNumber(it.duration_hours)} hours`;

    meta.appendChild(tgl);
    meta.appendChild(tipe);
    meta.appendChild(lang);
    meta.appendChild(paced);   
    meta.appendChild(lev);
    meta.appendChild(plat); 
    meta.appendChild(ska);
    meta.appendChild(dur);

    // const kv = document.createElement("div");
    // kv.className = "kv";
    // kv.appendChild(kvLine("Tanggal", `${norm(it.start_date)||"-"} → ${norm(it.end_date)||"-"}`));
    // kv.appendChild(kvLine("Level", norm(it.level)||"-"));
    // kv.appendChild(kvLine("Pacing/Type", norm(it.pacing_or_type)||"-"));
    // kv.appendChild(kvLine("Skala", norm(it.skala_institution)||"-"));
    // kv.appendChild(kvLine("Durasi", `${toNumber(it.duration_hours)} jam`));
    // kv.appendChild(kvLine("Category", splitSemi(it.category).join("; ") || "-", true));
    // kv.appendChild(kvLine("Kemampuan", splitSemi(it.kemampuan).join("; ") || "-", true));
    // kv.appendChild(kvLine("Fakultas", splitSemi(it.fakultas).join("; ") || "-", true));

    body.appendChild(logosWrap);
    body.appendChild(headline);
    body.appendChild(subheadline);
    body.appendChild(meta);
    // body.appendChild(kv);

    const foot = document.createElement("div");
    foot.className = "cardFoot";

    const url = safeUrl(it.course_url);
    const a = document.createElement("a");
    a.className = "linkBtn linkBtn--brand";
    a.href = url || "#";
    a.target = "_blank";
    a.rel = "noopener noreferrer";
    a.textContent = url ? "Detail" : "URL Tidak Tersedia";
    if (!url){
      a.onclick = (e) => e.preventDefault();
      a.style.opacity = .7;
      a.style.cursor = "not-allowed";
    }
    foot.appendChild(a);

    card.appendChild(media);
    card.appendChild(body);
    card.appendChild(foot);

    col.appendChild(card);
    return col;
  }

  function buildOptions(selectEl, values){
    const current = selectEl.value;
    selectEl.innerHTML = "";
    const optAll = document.createElement("option");
    optAll.value = "";
    optAll.textContent = "All";
    selectEl.appendChild(optAll);

    uniqueSorted(values).forEach(v => {
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      selectEl.appendChild(opt);
    });

    if ([...selectEl.options].some(o => o.value === current)) selectEl.value = current;
  }

  function rebuildFilterOptions(items){
    // fakultas: split ; + unik (sudah)
    const institutions = [], categories = [], skills = [], fakultas = [];
    const levels = [], pacings = [], bahasa = [], tipe = [], platform = [], skala = [];

    for (const it of items){
      splitSemi(it.institution).forEach(x => institutions.push(x));
      splitSemi(it.category).forEach(x => categories.push(x));
      splitSemi(it.kemampuan).forEach(x => skills.push(x));
      splitSemi(it.fakultas).forEach(x => fakultas.push(x)); // <-- split

      levels.push(norm(it.level));
      pacings.push(norm(it.pacing_or_type));
      bahasa.push(norm(it.bahasa));
      tipe.push(norm(it.tipe));
      platform.push(norm(it.platform));
      skala.push(norm(it.skala_institution));
    }

    buildOptions(filters.institution, institutions);
    buildOptions(filters.category, categories);
    buildOptions(filters.kemampuan, skills);
    buildOptions(filters.fakultas, fakultas); // <-- unik

    buildOptions(filters.level, levels.filter(Boolean));
    buildOptions(filters.pacing_or_type, pacings.filter(Boolean));
    buildOptions(filters.bahasa, bahasa.filter(Boolean));
    buildOptions(filters.tipe, tipe.filter(Boolean));
    buildOptions(filters.platform, platform.filter(Boolean));
    buildOptions(filters.skala_institution, skala.filter(Boolean));
  }

  function parseApiResponse(json){
    const values = json?.values;
    if (!Array.isArray(values) || values.length < 2) return [];
    const header = values[0].map(norm);
    const idx = {};
    header.forEach((h,i)=>{ idx[h]=i; });

    const rows = [];
    for (let r=1; r<values.length; r++){
      const row = values[r] || [];
      const obj = {};
      for (const col of COLS){
        const i = idx[col];
        obj[col] = (i === undefined) ? "" : (row[i] ?? "");
      }
      rows.push(obj);
    }
    return rows;
  }

  // Icons (inline SVG)
  const ICONS = {
    FEB: svg("briefcase"),
    Fakultas: svg("grid"),
    FKIP: svg("book"),
    FST: svg("flask"),
    FHISIP: svg("users"),
    SPS: svg("cap"),
    SV: svg("tools")
  };

  function svg(name){
    // stroke currentColor, simple icons
    const common = `fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"`;
    if (name === "briefcase") return `<svg viewBox="0 0 24 24" ${common}><path d="M10 6h4"></path><path d="M10 6a2 2 0 0 1 2-2 2 2 0 0 1 2 2"></path><path d="M4 8h16v10a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V8z"></path><path d="M4 12h16"></path></svg>`;
    if (name === "grid") return `<svg viewBox="0 0 24 24" ${common}><rect x="4" y="4" width="7" height="7" rx="2"></rect><rect x="13" y="4" width="7" height="7" rx="2"></rect><rect x="4" y="13" width="7" height="7" rx="2"></rect><rect x="13" y="13" width="7" height="7" rx="2"></rect></svg>`;
    if (name === "book") return `<svg viewBox="0 0 24 24" ${common}><path d="M4 19a2 2 0 0 0 2 2h12"></path><path d="M6 3h12a2 2 0 0 1 2 2v16H6a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"></path><path d="M8 7h8"></path><path d="M8 11h8"></path></svg>`;
    if (name === "flask") return `<svg viewBox="0 0 24 24" ${common}><path d="M10 2v6l-5 9a3 3 0 0 0 2.6 4.5h8.8A3 3 0 0 0 19 17l-5-9V2"></path><path d="M8 10h8"></path></svg>`;
    if (name === "users") return `<svg viewBox="0 0 24 24" ${common}><path d="M17 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2"></path><path d="M9 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"></path><path d="M21 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>`;
    if (name === "cap") return `<svg viewBox="0 0 24 24" ${common}><path d="M22 10L12 5 2 10l10 5 10-5z"></path><path d="M6 12v5a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-5"></path></svg>`;
    if (name === "tools") return `<svg viewBox="0 0 24 24" ${common}><path d="M14.7 6.3a4 4 0 0 0-5.4 5.4L3 18v3h3l6.3-6.3a4 4 0 0 0 5.4-5.4l-2.2 2.2-2.8-2.8 2-2.4z"></path></svg>`;
    return `<svg viewBox="0 0 24 24" ${common}><circle cx="12" cy="12" r="9"></circle></svg>`;
  }

  function updateQuickActive(){
    [...quickFakultas.querySelectorAll(".qbtn")].forEach(btn => {
      const val = btn.getAttribute("data-val") || "";
      btn.classList.toggle("active", val && norm(quickFaculty) === val);
    });
  }

  function renderQuickButtons(){
    quickFakultas.innerHTML = "";
    for (const name of QUICK_FAKULTAS){
      const b = document.createElement("button");
      b.type = "button";
      b.className = "qbtn";
      b.setAttribute("data-val", name);

      const ico = document.createElement("span");
      ico.className = "qico";
      ico.innerHTML = ICONS[name] || ICONS["Fakultas"];

      const label = document.createElement("span");
      label.className = "qlabel";
      label.innerHTML = `<span>${escapeHtml(name)}</span><small>Filter cepat</small>`;

      b.appendChild(ico);
      b.appendChild(label);

      b.addEventListener("click", () => {
        showLoading(`Memfilter fakultas: ${name}…`);
        try{
          // toggle quick faculty (contains-match)
          quickFaculty = (norm(quickFaculty) === name) ? "" : name;
          applyFilters();
        } finally {
          // small delay so it feels smooth
          setTimeout(hideLoading, 120);
        }
      });

      quickFakultas.appendChild(b);
    }
    updateQuickActive();
  }

  function applyFilters(){
    const query = lower(q.value);

    const f = {
      institution: norm(filters.institution.value),
      level: norm(filters.level.value),
      pacing_or_type: norm(filters.pacing_or_type.value),
      bahasa: norm(filters.bahasa.value),
      category: norm(filters.category.value),
      kemampuan: norm(filters.kemampuan.value),
      tipe: norm(filters.tipe.value),
      platform: norm(filters.platform.value),
      skala_institution: norm(filters.skala_institution.value),
      fakultas: norm(filters.fakultas.value), // dropdown faculty (split + unique)
      harga: norm(filters.harga.value),
      durMin: norm(filters.dur_min.value) ? toNumber(filters.dur_min.value) : null,
      durMax: norm(filters.dur_max.value) ? toNumber(filters.dur_max.value) : null,
      quickFaculty: norm(quickFaculty), // quick contains-match
    };

    filtered = raw.filter(it => {
      // SEARCH (kolom 18: search_index)
      if (query){
        const si = lower(it.search_index);
        if (!si.includes(query)) return false;
      }

      // Delimited fields exact membership (dropdown)
      if (f.institution && !splitSemi(it.institution).includes(f.institution)) return false;
      if (f.category && !splitSemi(it.category).includes(f.category)) return false;
      if (f.kemampuan && !splitSemi(it.kemampuan).includes(f.kemampuan)) return false;

      // Fakultas:
      // - dropdown: membership (split) OR contains fallback (lebih toleran)
      if (f.fakultas){
        const list = splitSemi(it.fakultas);
        const facStr = lower(it.fakultas);
        if (!list.includes(f.fakultas) && !facStr.includes(lower(f.fakultas))) return false;
      }

      // Quick faculty: CONTAINS (case-insensitive) — tidak exact match
      if (f.quickFaculty){
        const facStr = lower(it.fakultas);
        if (!facStr.includes(lower(f.quickFaculty))) return false;
      }

      // Non-delimited exact match
      if (f.level && norm(it.level) !== f.level) return false;
      if (f.pacing_or_type && norm(it.pacing_or_type) !== f.pacing_or_type) return false;
      if (f.bahasa && norm(it.bahasa) !== f.bahasa) return false;
      if (f.tipe && norm(it.tipe) !== f.tipe) return false;
      if (f.platform && norm(it.platform) !== f.platform) return false;
      if (f.skala_institution && norm(it.skala_institution) !== f.skala_institution) return false;

      // Harga
      if (f.harga && priceBucket(it.harga) !== f.harga) return false;

      // Duration range
      const dur = toNumber(it.duration_hours);
      if (f.durMin !== null && dur < f.durMin) return false;
      if (f.durMax !== null && dur > f.durMax) return false;

      return true;
    });

    // Sorting
    const s = sortBy.value;
    if (s === "relevance"){
      if (query) filtered.sort((a,b) => scoreSearch(b, query) - scoreSearch(a, query));
    } else if (s === "name_asc"){
      filtered.sort((a,b)=> norm(a.course_name).localeCompare(norm(b.course_name), "id", {sensitivity:"base"}));
    } else if (s === "name_desc"){
      filtered.sort((a,b)=> norm(b.course_name).localeCompare(norm(a.course_name), "id", {sensitivity:"base"}));
    } else if (s === "dur_asc"){
      filtered.sort((a,b)=> toNumber(a.duration_hours) - toNumber(b.duration_hours));
    } else if (s === "dur_desc"){
      filtered.sort((a,b)=> toNumber(b.duration_hours) - toNumber(a.duration_hours));
    } else if (s === "price_asc"){
      filtered.sort((a,b)=> toNumber(a.harga) - toNumber(b.harga));
    } else if (s === "price_desc"){
      filtered.sort((a,b)=> toNumber(b.harga) - toNumber(a.harga));
    }

    visible = 12;
    render();

    chipCount.textContent = `${filtered.length.toLocaleString("id-ID")} item`;
    resultInfo.textContent = filtered.length
      ? `Showing ${Math.min(visible, filtered.length).toLocaleString("id-ID")} from ${filtered.length.toLocaleString("id-ID")}`
      : `No Data`;

    activeFilters.textContent = String(countActiveFilters());
    updateQuickActive();
  }

  function render(){
    const total = filtered.length;
    const shown = Math.min(visible, total);

    cards.innerHTML = "";
    const slice = filtered.slice(0, shown);
    for (const it of slice) cards.appendChild(renderCard(it));

    btnMore.disabled = shown >= total;
    btnMore.textContent = shown >= total ? "Tidak ada lagi" : "Load More";
  }

  const debounced = (fn, ms=200) => {
    let t = null;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), ms);
    };
  };

  async function load(){
    showLoading("Loading catalog data…");
    try{
      statusBox.innerHTML = `<span class="spinner" aria-hidden="true"></span>Loading catalog data…`;
      const res = await fetch(API_URL, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();

      raw = parseApiResponse(json);

      statusBox.innerHTML = `✅ Data siap • <b>${raw.length.toLocaleString("id-ID")}</b> item`;
      rebuildFilterOptions(raw);
      renderQuickButtons();

      filtered = raw.slice();
      applyFilters();
    }catch(err){
      console.error(err);
      statusBox.innerHTML = `❌ Gagal memuat data. Cek API/akses CORS.`;
      btnMore.disabled = true;
    } finally {
      hideLoading();
    }
  }

  // Events + inline loading
  q.addEventListener("input", debounced(() => {
    showLoading("Mencari…");
    try{ applyFilters(); } finally { setTimeout(hideLoading, 120); }
  }, 220));

  sortBy.addEventListener("change", () => {
    showLoading("Mengurutkan…");
    try{ applyFilters(); } finally { setTimeout(hideLoading, 120); }
  });

  [
    filters.institution, filters.level, filters.pacing_or_type, filters.bahasa,
    filters.category, filters.kemampuan, filters.tipe, filters.platform,
    filters.skala_institution, filters.fakultas, filters.harga
  ].forEach(sel => {
    sel.addEventListener("change", () => {
      showLoading("Menerapkan filter…");
      try{ applyFilters(); } finally { setTimeout(hideLoading, 120); }
    });
  });

  [filters.dur_min, filters.dur_max].forEach(inp => {
    inp.addEventListener("input", debounced(() => {
      showLoading("Memfilter durasi…");
      try{ applyFilters(); } finally { setTimeout(hideLoading, 120); }
    }, 240));
  });

  btnMore.addEventListener("click", () => {
    showLoading("Memuat lebih banyak…");
    try{
      visible += 12;
      render();
    } finally {
      setTimeout(hideLoading, 140);
    }
  });

  btnReset.addEventListener("click", () => {
    showLoading("Reset…");
    try{
      q.value = "";
      Object.values(filters).forEach(f => {
        if (f.tagName === "SELECT") f.value = "";
        if (f.tagName === "INPUT") f.value = "";
      });
      sortBy.value = "relevance";
      quickFaculty = "";
      applyFilters();
    } finally {
      setTimeout(hideLoading, 140);
    }
  });

  // Start
  load();
})();
</script>
<div id="footer"></div>
</body>
</html>
