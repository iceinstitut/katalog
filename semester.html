<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Katalog Mata Kuliah Program ICE Institute Semester Terbaru</title>
  <script>
function loadComponent(id, url) {
    fetch("https://iceinstitut.github.io/konten/" + url)
    .then(response => response.text())
    .then(data => {
        document.getElementById(id).innerHTML = data;
    });
}

document.addEventListener("DOMContentLoaded", function() {
    loadComponent("header", "header.html");
    loadComponent("footer", "footer.html");
});

fetch("https://iceinstitut.github.io/konten/head.html")
.then(response => response.text())
.then(data => {
    const temp = document.createElement("div");
    temp.innerHTML = data;

    // Proses <link> langsung
    temp.querySelectorAll("link").forEach(link => {
        document.head.appendChild(link);
    });

    // Proses <script> manual
    temp.querySelectorAll("script").forEach(oldScript => {
        const newScript = document.createElement("script");
        newScript.src = oldScript.src;
        if (oldScript.defer) newScript.defer = true;
        document.head.appendChild(newScript);
    });
});
</script>
  <style>
:root{
  /* Light theme - ICE Institute branding */
  --mkapp-bg: #f6f8fb;
  --mkapp-panel: #ffffff;
  --mkapp-card: #ffffff;

  --mkapp-text: #0f172a;          /* slate-900 */
  --mkapp-muted: #64748b;         /* slate-500 */

  --mkapp-border: #e5e7eb;        /* gray-200 */
  --mkapp-soft: #f1f5f9;          /* slate-100 */

  /* Brand primary (ICE Institute) */
  --mkapp-primary: #ee1522;
  --mkapp-primary-hover: #d60f1b; /* slightly darker */
  --mkapp-primary-soft: #ffe7ea;  /* soft tint */

  /* Status */
  --mkapp-green: #16a34a;         /* green-600 */
  --mkapp-green-soft: #dcfce7;

  --mkapp-red: #dc2626;           /* red-600 */
  --mkapp-red-soft: #fee2e2;
}

*{ box-sizing:border-box; }
html,body{ height:100%; }

.mkapp-body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
  background: var(--mkapp-bg);
  color: var(--mkapp-text);
}

/* ===== Header ===== */
.mkapp-header{
  display: none;
  position: sticky;
  top:0;
  z-index: 20;
  background: var(--mkapp-panel);
  border-bottom: 1px solid var(--mkapp-border);
}

.mkapp-header__inner{
  max-width: 1200px;
  margin: 0 auto;
  padding: 16px 18px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 12px;
}

.mkapp-brand__title{
  font-size: 18px;
  font-weight: 900;
  letter-spacing:.2px;
}

.mkapp-brand__subtitle{
  margin-top: 2px;
  font-size: 12px;
  color: var(--mkapp-muted);
}

.mkapp-header__note{
  font-size: 12px;
  color: var(--mkapp-muted);
  padding: 6px 10px;
  border-radius: 999px;
  background: var(--mkapp-soft);
}

/* ===== Layout ===== */
.mkapp-main{
  max-width: 1200px;
  margin: 0 auto;
  padding: 18px;
}

.mkapp-controls{
  display:flex;
  flex-direction:column;
  gap: 14px;
  margin-top: 6px;
}

/* ===== Hero Section ===== */
.mkapp-hero{
  margin: 10px 0 16px;
  border: 1px solid var(--mkapp-border);
  background: var(--mkapp-panel);
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 4px 16px rgba(15,23,42,.04);
}

.mkapp-hero__inner{
  padding: 16px 16px 14px;
}

.mkapp-hero__title{
  margin: 0;
  /*font-size: 20px;*/
  font-size: calc(1.375rem + 1.5vw);
  font-weight: 950;
  letter-spacing: .2px;
}

.mkapp-hero__desc{
  margin: 8px 0 0;
  color: var(--mkapp-muted);
  line-height: 1.55;
  font-size: 13px;
}

.mkapp-platforms{
  margin-top: 12px;
  display: grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap: 10px;
}

@media (max-width: 860px){
  .mkapp-platforms{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
}

.mkapp-platformBtn{
  border: 1px solid var(--mkapp-border);
  background: var(--mkapp-panel);
  color: var(--mkapp-text);
  padding: 14px 12px;
  border-radius: 14px;
  cursor: pointer;
  font-weight: 900;
  text-align: center;
  box-shadow: 0 2px 10px rgba(15,23,42,.04);
  transition: transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease, color .12s ease;
}

.mkapp-platformBtn:hover{
  transform: translateY(-1px);
  box-shadow: 0 10px 22px rgba(15,23,42,.08);
  border-color: rgba(238,21,34,.25);
}

.mkapp-platformBtn.is-active{
  background: var(--mkapp-primary-soft);
  color: var(--mkapp-primary);
  border-color: rgba(238,21,34,.35);
}

/* ===== Search ===== */
.mkapp-search{
  background: var(--mkapp-panel);
  border: 1px solid var(--mkapp-border);
  border-radius: 14px;
  padding: 14px;
  box-shadow: 0 4px 16px rgba(15,23,42,.04);
}

.mkapp-search__input{
  width:100%;
  font-size: 18px;
  padding: 14px 14px;
  border-radius: 12px;
  border: 1px solid var(--mkapp-border);
  outline: none;
  background: #ffffff;
  color: var(--mkapp-text);
}

.mkapp-search__input:focus{
  border-color: rgba(238,21,34,.35);
  box-shadow: 0 0 0 4px rgba(238,21,34,.12);
}

.mkapp-search__input::placeholder{ color: rgba(100,116,139,.8); }

.mkapp-search__hint{
  margin-top: 10px;
  font-size: 12px;
  color: var(--mkapp-muted);
}

/* ===== Filters ===== */
.mkapp-filters{
  background: var(--mkapp-panel);
  border: 1px solid var(--mkapp-border);
  border-radius: 14px;
  padding: 14px;
  box-shadow: 0 4px 16px rgba(15,23,42,.04);
}

.mkapp-filters__grid{
  display:grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 12px;
}

@media (max-width: 980px){
  .mkapp-filters__grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
}
@media (max-width: 640px){
  .mkapp-filters__grid{ grid-template-columns: 1fr; }
}

.mkapp-field__label{
  display:block;
  font-size: 12px;
  color: var(--mkapp-muted);
  margin: 0 0 6px 2px;
}

.mkapp-field__select{
  width:100%;
  padding: 10px 10px;
  border-radius: 12px;
  border: 1px solid var(--mkapp-border);
  outline:none;
  background: #ffffff;
  color: var(--mkapp-text);
  appearance: none;
  background-image:
    linear-gradient(45deg, transparent 50%, rgba(100,116,139,.9) 50%),
    linear-gradient(135deg, rgba(100,116,139,.9) 50%, transparent 50%);
  background-position:
    calc(100% - 16px) calc(50% - 2px),
    calc(100% - 10px) calc(50% - 2px);
  background-size: 6px 6px, 6px 6px;
  background-repeat: no-repeat;
}

.mkapp-field__select:focus{
  border-color: rgba(238,21,34,.35);
  box-shadow: 0 0 0 4px rgba(238,21,34,.12);
}

.mkapp-filters__actions{
  display:flex;
  gap: 10px;
  justify-content:flex-end;
  margin-top: 12px;
}

/* ===== Buttons ===== */
.mkapp-btn{
  border: 1px solid var(--mkapp-border);
  background: var(--mkapp-panel);
  color: var(--mkapp-text);
  padding: 10px 14px;
  border-radius: 12px;
  cursor:pointer;
  font-weight: 800;
  transition: transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
}

.mkapp-btn:hover{
  background: var(--mkapp-soft);
  transform: translateY(-1px);
  box-shadow: 0 8px 18px rgba(15,23,42,.08);
}

.mkapp-btn--primary{
  background: var(--mkapp-primary);
  color: #fff;
  border-color: var(--mkapp-primary);
}

.mkapp-btn--primary:hover{
  background: var(--mkapp-primary-hover);
  border-color: var(--mkapp-primary-hover);
}

.mkapp-btn--ghost{
  background: transparent;
}

.mkapp-btn--wide{
  width: min(420px, 100%);
}

/* ===== Status bar ===== */
.mkapp-statusbar{
  margin-top: 14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.mkapp-info{
  font-size: 13px;
  color: var(--mkapp-muted);
}

/* ===== Grid ===== */
.mkapp-gridwrap{
  margin-top: 14px;
}

.mkapp-grid{
  display:grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap: 12px;
  align-items: stretch;      /* penting: item satu baris punya tinggi sama */
}

.mkapp-grid > *{
  height: 100%;
}

@media (max-width: 1100px){
  .mkapp-grid{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
}
@media (max-width: 860px){
  .mkapp-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
}
@media (max-width: 560px){
  .mkapp-grid{ grid-template-columns: 1fr; }
}

/* ===== Card ===== */
.mkapp-card{
  background: var(--mkapp-card);
  border: 1px solid var(--mkapp-border);
  border-radius: 16px;
  overflow:hidden;
  height: 100%;
  display:flex;
  flex-direction:column;
  min-height: 100%;
  box-shadow: 0 4px 16px rgba(15,23,42,.06);
  transition: transform .15s ease, box-shadow .15s ease;
}

.mkapp-card:hover{
  transform: translateY(-2px);
  box-shadow: 0 10px 28px rgba(15,23,42,.10);
}

/* ===== Footer (INI KUNCI) ===== */
.mkapp-card__footer{
  margin-top:auto;                 /* footer selalu di bawah */
  padding:0px 12px 12px;
  background:var(--mkapp-panel);
}

/* Force 16:9 media area */
.mkapp-media{
  position: relative;
  width: 100%;
  aspect-ratio: 16 / 9;
  overflow: hidden;
  background: #e5e7eb;
  border-bottom: 1px solid var(--mkapp-border);
}

.mkapp-media__img{
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  display:block;
  object-fit: cover;
  object-position: center;
}

.mkapp-card__body{
  padding: 12px;
  display:flex;
  flex-direction:column;
  flex: 1;
  gap: 10px;
  min-height: 0;
}

.mkapp-row{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap: 10px;
}

.mkapp-title{
  font-size: 14px;
  font-weight: 900;
  line-height: 1.2;
}

.mkapp-meta{
  display: none;
  font-size: 12px;
  color: var(--mkapp-muted);
  line-height: 1.35;
}

/* ===== Badges ===== */
.mkapp-badge{
  font-size: 11px;
  padding: 6px 8px;
  border-radius: 999px;
  font-weight: 900;
  white-space: nowrap;
  border: 1px solid var(--mkapp-border);
}

.mkapp-badge--green{
  background: var(--mkapp-green-soft);
  color: var(--mkapp-green);
  border-color: rgba(22,163,74,.25);
}

.mkapp-badge--red{
  background: var(--mkapp-red-soft);
  color: var(--mkapp-red);
  border-color: rgba(220,38,38,.25);
}

/* ===== Key-value grid ===== */
.mkapp-grid2{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}

.mkapp-kv{
  background: var(--mkapp-soft);
  border: 1px solid var(--mkapp-border);
  border-radius: 12px;
  padding: 8px 10px;
}

.mkapp-kv__k{
  font-size: 11px;
  color: var(--mkapp-muted);
  margin-bottom: 3px;
}

.mkapp-kv__v{
  font-size: 12px;
  color: var(--mkapp-text);
  font-weight: 800;
  word-break: break-word;
}

/* ===== Logos ===== */
.mkapp-logos{
  display:flex;
  flex-wrap: wrap;
  gap: 8px;
}

.mkapp-logoCard{
  width: 64px;
  height: 64px;
  border-radius: 12px;
  border: 1px solid var(--mkapp-border);
  background: #fff;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
  box-shadow: 0 2px 10px rgba(15,23,42,.04);
}

.mkapp-logoCard__img{
  width: 100%;
  height: 100%;
  object-fit: contain;
  padding: 4px 5px;
}

/* ===== Actions ===== */
.mkapp-actions{
  display:flex;
  gap: 10px;
  margin-top: 2px;
}

.mkapp-linkbtn{
  display:inline-flex;
  width: 100%;
  align-items:center;
  justify-content:center;
  text-decoration:none;
  padding: 10px 12px;
  border-radius: 12px;
  background: #ffffff;
  border: 1px solid var(--mkapp-border);
  color: var(--mkapp-text);
  font-weight: 900;
  font-size: 12px;
  transition: background .12s ease, transform .12s ease, box-shadow .12s ease, border-color .12s ease, color .12s ease;
}

.mkapp-linkbtn:hover{
  background: var(--mkapp-primary-soft);
  color: var(--mkapp-primary);
  border-color: rgba(238,21,34,.25);
  transform: translateY(-1px);
  box-shadow: 0 8px 18px rgba(15,23,42,.08);
}

/* ===== Load more ===== */
.mkapp-loadmore{
  display:flex;
  justify-content:center;
  margin: 16px 0 0;
}

.mkapp-footerpad{
  height: 24px;
}
</style>
</head>
<body class="mkapp-body">
  <div id="header"></div>
  <header class="mkapp-header">
    <div class="mkapp-header__inner">
      <div class="mkapp-brand">
        <div class="mkapp-brand__title">Katalog Mata Kuliah</div>
        <div class="mkapp-brand__subtitle">Cari • Filter • Load more</div>
      </div>
      <div class="mkapp-header__note" id="mkappHeaderNote">Ready</div>
    </div>
  </header>

  <main class="mkapp-main">
    <section class="mkapp-hero">
      <div class="mkapp-hero__inner">
        <h1 class="mkapp-hero__title">Katalog Mata Kuliah Program ICE Institute Semester 2026_1</h1>
        <p class="mkapp-hero__desc">
          Gunakan kolom pencarian dan filter untuk menemukan mata kuliah yang sesuai. Kamu juga bisa memilih platform di bawah
          untuk memfilter data secara cepat.
        </p>

        <div class="mkapp-platforms" role="group" aria-label="Filter cepat platform">
          <button class="mkapp-platformBtn" type="button" data-platform="ICE Institute">ICE Institute</button>
          <button class="mkapp-platformBtn" type="button" data-platform="XuetangX">XuetangX</button>
          <button class="mkapp-platformBtn" type="button" data-platform="edX">edX</button>
          <button class="mkapp-platformBtn" type="button" data-platform="Coursera">Coursera</button>
        </div>
      </div>
    </section>

    <section class="mkapp-controls">
      <div class="mkapp-search">
        <input id="mkappSearchInput" class="mkapp-search__input" type="search"
               placeholder="Cari mata kuliah / institusi / kode…"
               autocomplete="off" />
        <div class="mkapp-search__hint">Ketikkan minimal 4 huruf</div>
      </div>

      <div class="mkapp-filters">
  <div class="mkapp-filters__grid">

    <div class="mkapp-field" style="display:none;">
      <label class="mkapp-field__label" for="mkappFilterPlatform">Platform</label>
      <select class="mkapp-field__select" id="mkappFilterPlatform">
        <option value="">Semua</option>
      </select>
    </div>

    <div class="mkapp-field" style="display:none;">
      <label class="mkapp-field__label" for="mkappFilterPartner">Partner</label>
      <select class="mkapp-field__select" id="mkappFilterPartner">
        <option value="">Semua</option>
      </select>
    </div>

    <div class="mkapp-field">
      <label class="mkapp-field__label" for="mkappFilterInstitusi">Institusi</label>
      <select class="mkapp-field__select" id="mkappFilterInstitusi">
        <option value="">Semua</option>
      </select>
    </div>

    <div class="mkapp-field">
      <label class="mkapp-field__label" for="mkappFilterJenjang">Jenjang</label>
      <select class="mkapp-field__select" id="mkappFilterJenjang">
        <option value="">Semua</option>
      </select>
    </div>

    <div class="mkapp-field">
      <label class="mkapp-field__label" for="mkappFilterSks">SKS/Jumlah Jam</label>
      <select class="mkapp-field__select" id="mkappFilterSks">
        <option value="">Semua</option>
      </select>
    </div>

    <div class="mkapp-field">
      <label class="mkapp-field__label" for="mkappFilterBahasa">Bahasa Pengantar</label>
      <select class="mkapp-field__select" id="mkappFilterBahasa">
        <option value="">Semua</option>
      </select>
    </div>

    <div class="mkapp-field">
      <label class="mkapp-field__label" for="mkappFilterTipe">Tipe Mata Kuliah</label>
      <select class="mkapp-field__select" id="mkappFilterTipe">
        <option value="">Semua</option>
      </select>
    </div>

    <div class="mkapp-field" style="display:none;">
      <label class="mkapp-field__label" for="mkappFilterAwal">Awal Kuliah</label>
      <select class="mkapp-field__select" id="mkappFilterAwal">
        <option value="">Semua</option>
      </select>
    </div>

    <div class="mkapp-field">
      <label class="mkapp-field__label" for="mkappFilterStatus">Status</label>
      <select class="mkapp-field__select" id="mkappFilterStatus">
        <option value="">Semua</option>
        <!-- akan diisi facets juga, tapi ini fallback -->
        <option value="Tersedia">Tersedia</option>
        <option value="Penuh">Penuh</option>
      </select>
    </div>

  </div>

  <div class="mkapp-filters__actions">
    <button id="mkappBtnApply" class="mkapp-btn mkapp-btn--primary">Terapkan</button>
    <button id="mkappBtnReset" class="mkapp-btn mkapp-btn--ghost">Reset</button>
  </div>
</div>
    </section>

    <section class="mkapp-statusbar">
      <div id="mkappInfo" class="mkapp-info">Memuat…</div>
    </section>

    <section class="mkapp-gridwrap">
      <div id="mkappGrid" class="mkapp-grid"></div>

      <div class="mkapp-loadmore">
        <button id="mkappBtnLoadMore" class="mkapp-btn mkapp-btn--primary mkapp-btn--wide">
          Load more
        </button>
      </div>
    </section>

    <section class="mkapp-footerpad"></section>
  </main>
  <div id="footer"></div>
  <script>
/* =========================
   CONFIG
========================= */
const API_BASE = "https://script.google.com/macros/s/AKfycbwahPXQKNaBwe-CEm8bbpUfpa3eHSavEH748FRxdWUoehtNUkyUT-utB_OOZQdmP5UiUQ/exec"; // https://script.google.com/macros/s/XXXX/exec
const CACHE_TTL_MS = 25 * 60 * 1000;
const DEFAULT_LIMIT = 40;

/* =========================
   STATE
========================= */
const mkappState = {
  items: [],
  nextCursor: null,
  hasMore: true,
  loading: false,
  requestToken: 0,
  debounceTimer: null,
};

/* =========================
   DOM
========================= */
const elGrid = document.getElementById("mkappGrid");
const elInfo = document.getElementById("mkappInfo");
const elBtnLoadMore = document.getElementById("mkappBtnLoadMore");
const elHeaderNote = document.getElementById("mkappHeaderNote");

const elSearch = document.getElementById("mkappSearchInput");
const elBtnApply = document.getElementById("mkappBtnApply");
const elBtnReset = document.getElementById("mkappBtnReset");

const elF = {
  platform: document.getElementById("mkappFilterPlatform"),
  partner: document.getElementById("mkappFilterPartner"),
  institusi_claen: document.getElementById("mkappFilterInstitusi"),
  jenjang: document.getElementById("mkappFilterJenjang"),
  sks: document.getElementById("mkappFilterSks"),
  bahasa_pengantar: document.getElementById("mkappFilterBahasa"),
  tipe_mata_kuliah: document.getElementById("mkappFilterTipe"),
  awal_kuliah: document.getElementById("mkappFilterAwal"),
  status: document.getElementById("mkappFilterStatus"),
};

const FACET_FIELDS = [
  "platform",
  "partner",
  "institusi_claen",
  "jenjang",
  "sks",
  "bahasa_pengantar",
  "tipe_mata_kuliah",
  "awal_kuliah",
  "status",
];

/* =========================
   INIT
========================= */
setupEvents();
initApp();

/* =========================
   INIT FLOW
========================= */
async function initApp() {
  setInfo("Memuat filter…");
  setHeaderNote("Loading…");
  setLoadMoreEnabled(false);

  await loadFacets();   // isi dropdown dari kolom sendiri (backend facets)
  await resetAndLoad(); // load page pertama
}

/* =========================
   EVENTS
========================= */
function setupEvents() {
  elBtnLoadMore.addEventListener("click", () => loadMore());

  elBtnApply.addEventListener("click", () => resetAndLoad());

  elBtnReset.addEventListener("click", async () => {
    elSearch.value = "";
    Object.values(elF).forEach(sel => sel.value = "");
    await resetAndLoad();
  });

  // Debounce search
  elSearch.addEventListener("input", () => {
    if (mkappState.debounceTimer) clearTimeout(mkappState.debounceTimer);
    mkappState.debounceTimer = setTimeout(() => resetAndLoad(), 450);
  });

  elSearch.addEventListener("keydown", (e) => {
    if (e.key === "Enter") resetAndLoad();
  });

  elF.platform.addEventListener("change", () => {
    setActivePlatformButton(elF.platform.value || "");
  });
}

  // Quick platform buttons
  document.querySelectorAll(".mkapp-platformBtn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const platform = (btn.dataset.platform || "").trim();
      if (!platform) return;

      // set dropdown platform
      elF.platform.value = platform;

      // set active state button
      setActivePlatformButton(platform);

      // reload list
      await resetAndLoad();
    });
  });

function setActivePlatformButton(platformValue) {
  const pv = String(platformValue || "").toLowerCase();
  document.querySelectorAll(".mkapp-platformBtn").forEach(b => {
    const bp = String(b.dataset.platform || "").toLowerCase();
    b.classList.toggle("is-active", bp === pv);
  });
}


/* =========================
   FACETS (dropdown options)
========================= */
async function loadFacets() {
  const cacheKey = "mkapp_facets_cache";
  const cached = readCache(cacheKey);

  if (cached && cached.status === "ok" && cached.data) {
    fillFacetSelects(cached.data);
    setHeaderNote("Facets cache");
    return;
  }

  try {
    const url = buildUrl({ action: "facets" });
    const resp = await fetchJson(url);

    if (resp && resp.status === "ok" && resp.data) {
      // backend sudah sort A–Z; tetap aman kalau mau sort ulang
      fillFacetSelects(resp.data);
      writeCache(cacheKey, resp);
      setHeaderNote("Facets network");
      return;
    }

    setHeaderNote("Facets error");
  } catch (err) {
    setHeaderNote("Facets error");
  }
}

function fillFacetSelects(facets) {
  for (const field of FACET_FIELDS) {
    const el = elF[field];
    if (!el) continue;

    const opts = Array.isArray(facets[field]) ? facets[field] : [];
    // defensive sort A–Z
    opts.sort((a, b) => String(a).toLowerCase().localeCompare(String(b).toLowerCase()));

    fillSelect(el, opts);
    // kalau platform sudah terpilih (mis. dari quick button), set state aktif
    if (elF.platform && elF.platform.value) {
      setActivePlatformButton(elF.platform.value);
    } else {
      setActivePlatformButton("");
    }
  }
}

function fillSelect(selectEl, options) {
  const current = selectEl.value;

  // reset options, keep default "Semua"
  selectEl.innerHTML = "";
  const optAll = document.createElement("option");
  optAll.value = "";
  optAll.textContent = "Semua";
  selectEl.appendChild(optAll);

  for (const v of options) {
    const s = String(v || "").trim();
    if (!s) continue;
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    selectEl.appendChild(opt);
  }

  // restore previous selection if still exists
  if (current) selectEl.value = current;
}

/* =========================
   LOAD FLOW
========================= */
async function resetAndLoad() {
  mkappState.items = [];
  mkappState.nextCursor = null;
  mkappState.hasMore = true;

  elGrid.innerHTML = "";
  setInfo("Memuat data…");
  setLoadMoreEnabled(false);

  await loadMore(true);
}

async function loadMore(isFirstPage = false) {
  if (mkappState.loading) return;
  if (!mkappState.hasMore && !isFirstPage) return;

  mkappState.loading = true;
  setLoadMoreEnabled(false);

  const params = buildParams();
  params.limit = String(DEFAULT_LIMIT);
  if (mkappState.nextCursor) params.cursor = mkappState.nextCursor;

  const url = buildUrl(params);
  const cacheKey = makeCacheKey(params);
  const token = ++mkappState.requestToken;

  try {
    const cached = readCache(cacheKey);
    let resp;

    if (cached) {
      resp = cached;
      setHeaderNote("Cache");
    } else {
      setHeaderNote("Network");
      resp = await fetchJson(url);
      writeCache(cacheKey, resp);
    }

    if (token !== mkappState.requestToken) return;

    if (!resp || resp.status !== "ok") {
      setInfo("Gagal memuat: " + (resp && resp.message ? resp.message : "Unknown error"));
      mkappState.loading = false;
      setLoadMoreEnabled(false);
      setHeaderNote("Error");
      return;
    }

    const newItems = Array.isArray(resp.data) ? resp.data : [];
    mkappState.items.push(...newItems);

    mkappState.nextCursor = resp.meta && resp.meta.next_cursor ? resp.meta.next_cursor : null;
    mkappState.hasMore = !!(resp.meta && resp.meta.has_more);

    renderAppend(newItems);

    const shown = mkappState.items.length;
    const moreTxt = mkappState.hasMore ? "Klik Load more untuk lanjut." : "Sudah paling akhir.";
    setInfo(`Menampilkan ${shown} data. ${moreTxt}`);

    mkappState.loading = false;
    setLoadMoreEnabled(mkappState.hasMore);
    setHeaderNote(mkappState.hasMore ? "Ready" : "Done");
  } catch (err) {
    if (token !== mkappState.requestToken) return;
    mkappState.loading = false;
    setInfo("Error: " + String(err));
    setHeaderNote("Error");
    setLoadMoreEnabled(false);
  }
}

/* =========================
   FETCH
========================= */
async function fetchJson(url) {
  const res = await fetch(url, { method: "GET" });
  const text = await res.text();
  try {
    return JSON.parse(text);
  } catch {
    throw new Error("Response bukan JSON: " + text.slice(0, 200));
  }
}

/* =========================
   PARAMS
========================= */
function buildParams() {
  const p = { action: "list" };

  const q = (elSearch.value || "").trim();
  if (q) p.q = q;

  // dropdown: exact match backend (case-insensitive)
  for (const f of FACET_FIELDS) {
    const val = (elF[f].value || "").trim();
    if (val) p[f] = val;
  }

  return p;
}

function buildUrl(params) {
  const u = new URL(API_BASE);
  Object.entries(params).forEach(([k, v]) => u.searchParams.set(k, v));
  return u.toString();
}

function makeCacheKey(params) {
  const keys = Object.keys(params).sort();
  const parts = keys.map(k => `${k}=${encodeURIComponent(params[k])}`);
  return "mkapp_cache:" + parts.join("&");
}

/* =========================
   CACHE (localStorage TTL)
========================= */
function readCache(key) {
  try {
    const raw = localStorage.getItem(key);
    if (!raw) return null;
    const obj = JSON.parse(raw);
    if (!obj || !obj.t || !obj.v) return null;
    if (Date.now() - obj.t > CACHE_TTL_MS) {
      localStorage.removeItem(key);
      return null;
    }
    return obj.v;
  } catch {
    return null;
  }
}

function writeCache(key, value) {
  try {
    const obj = { t: Date.now(), v: value };
    localStorage.setItem(key, JSON.stringify(obj));
  } catch {
    // storage penuh / disabled → abaikan
  }
}

/* =========================
   RENDER
========================= */
function renderAppend(items) {
  const frag = document.createDocumentFragment();
  for (const it of items) frag.appendChild(renderCard(it));
  elGrid.appendChild(frag);
}

function renderCard(it) {
  const card = document.createElement("article");
  card.className = "mkapp-card";

  // cover image (card)
  const media = document.createElement("div");
  media.className = "mkapp-media";

  const img = document.createElement("img");
  img.className = "mkapp-media__img";
  img.alt = safeText(it.nama_mata_kuliah || "Gambar");
  img.loading = "lazy";
  img.decoding = "async"; // opsional tapi bagus
  const cardUrl = safeUrl(it.card);
  if (cardUrl) img.src = cardUrl;
  img.onerror = () => { media.style.display = "none"; };
  media.appendChild(img);

  // body
  const body = document.createElement("div");
  body.className = "mkapp-card__body";

  const rowTop = document.createElement("div");
  rowTop.className = "mkapp-row";

  const title = document.createElement("div");
  title.className = "mkapp-title";
  title.textContent = safeText(it.nama_mata_kuliah || "-");

  const badge = document.createElement("div");
  const statusTxt = String(it.status || "").trim();
  const statusNorm = statusTxt.toLowerCase();
  const isPenuh = statusNorm.includes("penuh");
  badge.className = "mkapp-badge " + (isPenuh ? "mkapp-badge--red" : "mkapp-badge--green");
  badge.textContent = statusTxt || "—";

  rowTop.appendChild(title);
  rowTop.appendChild(badge);

  const meta = document.createElement("div");
  meta.className = "mkapp-meta";
  meta.textContent = safeText(it.kode_mata_kuliah || "");

  const kv = document.createElement("div");
  kv.className = "mkapp-grid2";
  kv.appendChild(kvBox("Jenjang", it.jenjang));
  kv.appendChild(kvBox("SKS/Jumlah Jam", it.sks));
  kv.appendChild(kvBox("Bahasa", it.bahasa_pengantar));
  kv.appendChild(kvBox("Tipe", it.tipe_mata_kuliah));
  kv.appendChild(kvBox("Jadwal", it.awal_kuliah));

  // logos (multi url separated by ;)
  const logoUrls = splitMultiUrls(it.logo);
  if (logoUrls.length) {
    const logosLabel = document.createElement("div");
    logosLabel.className = "mkapp-meta";
    logosLabel.textContent = "Logo";

    const logosWrap = document.createElement("div");
    logosWrap.className = "mkapp-logos";

    for (const u of logoUrls) {
      const lc = document.createElement("div");
      lc.className = "mkapp-logoCard";

      const li = document.createElement("img");
      li.className = "mkapp-logoCard__img";
      li.alt = "Logo";
      li.loading = "lazy";
      li.decoding = "async"; // opsional
      li.src = u;
      li.onerror = () => { lc.style.display = "none"; };

      lc.appendChild(li);
      logosWrap.appendChild(lc);
    }

    body.appendChild(logosLabel);
    body.appendChild(logosWrap);
  }

  // append main content to body
  body.appendChild(rowTop);
  body.appendChild(meta);
  body.appendChild(kv);

  // footer (NEW): actions dipindah ke sini
  const footer = document.createElement("div");
  footer.className = "mkapp-card__footer";

  const actions = document.createElement("div");
  actions.className = "mkapp-actions";

  const a = document.createElement("a");
  a.className = "mkapp-linkbtn";
  a.textContent = "Detail";
  const link = safeUrl(it.link);
  if (link) {
    a.href = link;
    a.target = "_blank";
    a.rel = "noopener";
  } else {
    a.href = "#";
    a.style.opacity = "0.6";
    a.style.pointerEvents = "none";
  }

  actions.appendChild(a);
  footer.appendChild(actions);

  // assemble card
  if (cardUrl) card.appendChild(media);
  card.appendChild(body);
  card.appendChild(footer);

  return card;
}

function kvBox(k, v) {
  const box = document.createElement("div");
  box.className = "mkapp-kv";

  const kk = document.createElement("div");
  kk.className = "mkapp-kv__k";
  kk.textContent = k;

  const vv = document.createElement("div");
  vv.className = "mkapp-kv__v";
  vv.textContent = safeText(v || "—");

  box.appendChild(kk);
  box.appendChild(vv);
  return box;
}

/* =========================
   UI helpers
========================= */
function setInfo(msg) { elInfo.textContent = msg; }
function setHeaderNote(msg) { elHeaderNote.textContent = msg; }
function setLoadMoreEnabled(enabled) {
  elBtnLoadMore.disabled = !enabled;
  elBtnLoadMore.style.opacity = enabled ? "1" : "0.6";
  elBtnLoadMore.style.pointerEvents = enabled ? "auto" : "none";
}

/* =========================
   utils
========================= */
function safeText(v) {
  if (v === null || v === undefined) return "";
  return String(v);
}
function safeUrl(v) {
  const s = (v === null || v === undefined) ? "" : String(v).trim();
  if (!s) return "";
  if (/^https?:\/\//i.test(s)) return s;
  return "";
}
function splitMultiUrls(v) {
  const s = (v === null || v === undefined) ? "" : String(v);
  if (!s.trim()) return [];
  return s.split(";").map(x => x.trim()).filter(Boolean).map(safeUrl).filter(Boolean);
}
  </script>
</body>

</html>
